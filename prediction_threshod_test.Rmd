---
title: "scoretest"
output: html_document
date: "2023-09-09"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
library("ggsci")
library(dplyr)
library(tidyr)
library(data.table)

test=readRDS("~/multistate2/output/test.rds")
pce.reverse.tenyear=readRDS("~/multistate2/output/pce.reverse.tenyear.rds")
ascvd.30.year=readRDS("~/multistate2/output/ascvd.30year.rds")
#ascvd.30.year.rc=readRDS("~/multistate2/output/ascvd.30year.rc.rds")
ascvd.30.year.rc=readRDS("~/multistate2/output/ascvd.30year.rcnew.rds")

head(pce.reverse.tenyear)
agesint=c(40:80)
thresh=5;
ten=apply(pce.reverse.tenyear,1,function(x){min(agesint[x>thresh])})
thresh=10;
thirty=apply(ascvd.30.year.rc,1,function(x){min(agesint[x>thresh])})


### this is the data frame with approportiate score
states=readRDS("~/multistate2/output/state_occupancy_risk.rds")
ages=c(40:80)
thresh=0.10;
t=sapply(1:length(states),function(x){w=which(states[[x]]>thresh);ifelse(length(w)>0,min(ages[w]),100)})

df=data.frame("id"=test$identifier,"Cad_0_Any"=test$Cad_0_Any,"Cad_0_censor_age"=test$Cad_0_censor_age,"sex"=test$f.31.0.0,"prs"=test$cad.prs,"ten"=ten,"thirty"=thirty,"ms"=t)

data <- data.frame(t_val = t)
# Create the ggplot histogram
p <- ggplot(data, aes(x = t_val)) +
geom_histogram(bins = length(ages) - 1, fill = "red", color = "black", alpha = 0.7, aes(y =after_stat(density))) +
labs(title = "Histogram of Age Exceeding Risk: MSGene LT",
x = "Value of t",
y = "Density")+theme_classic()+xlim(35,102)


data <- data.frame(t_val = ten)
# Create the ggplot histogram
p2 <- ggplot(data, aes(x = t_val)) +
geom_histogram(bins = length(ages) - 1, fill = "blue", color = "black", alpha = 0.7, aes(y =after_stat(density))) +
labs(title = "Histogram of Age Exceeding Risk: Ten year",
x = "Value of t",y = "Density")+theme_classic()+xlim(39,80)

data <- data.frame(t_val = thirty)
# Create the ggplot histogram
p3 <- ggplot(data, aes(x = t_val)) +
geom_histogram(bins = length(ages) - 1, fill = "green", color = "black", alpha = 0.7, aes(y =after_stat(density))) +
labs(title = "Histogram of Age Exceeding Risk: 30-year",
x = "Value of t",y = "Density")+theme_classic()+xlim(39,80)

ggarrange(p,p2,p3,nrow = 3)





```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}

df_expanded <- data.frame(
  id = integer(), 
  start = numeric(), 
  stop = numeric(), 
  event = integer(), 
  score1 = integer(), 
  score2 = integer()
)


library(data.table)

# Convert df to data.table
# Convert df to data.table
setDT(df)

expand_data <- function(id, cad_status, censor_age, score1_age, score2_age) {
  ages <- sort(c(40, score1_age, score2_age, censor_age))
  result <- list()
  
  for(j in 1:(length(ages) - 1)) {
    start_age <- ages[j]
    stop_age <- ages[j+1]
    
    if(start_age == stop_age) next # skip if they are the same
    
    s1 <- ifelse(start_age >= score1_age, 1, 0)
    s2 <- ifelse(start_age >= score2_age, 1, 0)
    
    event_at_stop <- ifelse(stop_age == censor_age && cad_status == 2, 1, 0)
    
    result[[length(result) + 1]] <- list(id = id, start = start_age, stop = stop_age, event = event_at_stop, score1 = s1, score2 = s2)
  }
  
  return(result)
}

list_dt <- lapply(1:nrow(df), function(i) {
  row <- df[i,]
  expand_data(row$id, row$Cad_0_Any, row$Cad_0_censor_age, row$thirty, row$ms)
})

df_expanded <- rbindlist(unlist(list_dt, recursive = FALSE))




library(survival)

# Bootstrap function for C-index
bootstrap_cindex <- function(fit_function, data, n_iter=10) {
  cindices <- numeric(n_iter)
  
  for(i in 1:n_iter) {
    sample_rows <- sample(1:nrow(data), replace = TRUE)
    sample_data <- data[sample_rows, ]
    
    fit <- fit_function(sample_data)
    cindices[i] <- summary(fit)$concordance[1]
  }
  
  return(list(mean = mean(cindices), se = sd(cindices)))
}

# Fit functions for score1 and score2
fit_function_score1 <- function(data) coxph(Surv(start, stop, event) ~ score1, data = data)
fit_function_score2 <- function(data) coxph(Surv(start, stop, event) ~ score2, data = data)


# Bootstrap C-index

results_score1 <- bootstrap_cindex(fit_function_score1, df_expanded)
results_score2 <- bootstrap_cindex(fit_function_score2, df_expanded)


# Confidence intervals (95%)
ci_score1 <- c(results_score1$mean - 1.96*results_score1$se, results_score1$mean + 1.96*results_score1$se)
ci_score2 <- c(results_score2$mean - 1.96*results_score2$se, results_score2$mean + 1.96*results_score2$se)

# Plot using ggplot2
library(ggplot2)

df_cindex <- data.frame(
  Score = c("30 Year", "MSGene"),
  Cindex = c(results_score1$mean, results_score2$mean),
  ymin = c(ci_score1[1], ci_score2[1]),
  ymax = c(ci_score1[2], ci_score2[2])
)

p <- ggplot(df_cindex, aes(x = Score, y = Cindex,fill=Score)) +
  geom_bar(stat = "identity", position = position_dodge()) +
  geom_errorbar(aes(ymin=ymin, ymax=ymax), width=0.1, position=position_dodge(0.9)) +
  ylim(0,0.8 ) +
  labs(
    title = "Comparison of Predictive Performance",
    subtitle = "Using Bootstrap 95% CI for C-index (Concordance Index)",
    y = "C-index Value",
    x = ""
  ) +
  theme_classic()+scale_fill_aaas()

print(p)
fit1 <- coxph(Surv(start, stop, event) ~ score1, data = df_expanded)
fit2 <- coxph(Surv(start, stop, event) ~ score2, data = df_expanded)

# Comparing models based on AIC
aic1 <- AIC(fit1)
aic2 <- AIC(fit2)

cat("AIC for FRS.30y:", aic1, "\n")
cat("AIC for msGene:", aic2, "\n")
```



Now do for continous variable brier score:


```{r}
df=test
score1_list=states
score2=ascvd.30.year.rc
df$Cad_0_censor_age=round(df$Cad_0_censor_age,0)
df$Cad_0_Any=ifelse(df$Cad_0_Any==2,1,0)




expanded_df <- data.frame()
df=test
score1_list=states
names(states)=df$identifier
score2=ascvd.30.year.rc
rownames(score2)=df$identifier
df$Cad_0_censor_age=round(df$Cad_0_censor_age,0)
df$Cad_0_Any=ifelse(df$Cad_0_Any==2,1,0)

bad_indices=which(df$Cad_0_censor_age>=80&df$Cad_0_Any==1)

# Removing the bad IDs from score1_list
score1_list <- score1_list[-bad_indices]

# Removing the bad IDs from score2 dataframe
score2 <- score2[-bad_indices, ]


df=df[-which(df$Cad_0_censor_age>=80&df$Cad_0_Any==1),]
dim(df)

all.equal(as.numeric(names(score1_list)),as.numeric(df$identifier))

all.equal(as.numeric(rownames(score2)),as.numeric(df$identifier))
# Initialize a list to store the results
expanded_list <- vector("list", length = nrow(df))

for(i in 1:nrow(df)) {
  print(i)
  id <- df$id[i]
  max_age <- df$Cad_0_censor_age[i]
  event <- df$Cad_0_Any[i]
  
  # When max_age is less than 40 or length of score1_list[i] is 0
  if (max_age < 40 || length(score1_list[[i]]) == 0) {
    next  # Skip this iteration and proceed to the next
  }
  
  age_range <- 40:(40 + length(score1_list[[i]]) - 1)
  score1_values <- score1_list[[i]]
  score2_values <- score2[i, age_range - 39]
  
  # If there's an event and score1 is shorter than expected
  if (event == 1 && max(age_range) < max_age) {
    extended_age_range <- (max(age_range) + 1):max_age  
    score1_last_value <- rep(tail(score1_list[[i]], 1), times = length(extended_age_range))
    score1_values <- c(score1_list[[i]], score1_last_value)
    score2_last_value <- score2[i,(extended_age_range-39)]
    score2_values <- c(score2_values, score2_last_value)
    age_range <- c(age_range, extended_age_range)
  }
  
  # Store the resulting dataframe as a list element
  expanded_list[[i]] <- data.frame(id = id,
                                   age = age_range,
                                   score1 = score1_values,
                                   score2 = score2_values,
                                   event = ifelse(age_range == max_age, event, 0))
}

# Combine all the dataframes in the list at once
expanded_df <- do.call(rbind, expanded_list)
expanded_df$score1=expanded_df$score1*100
expanded_df$start <- expanded_df$age
expanded_df$stop <- expanded_df$age + 1


print(dim(expanded_df))

# Bootstrap C-index
results_score1 <- bootstrap_cindex(fit_function_score1, expanded_df)
results_score2 <- bootstrap_cindex(fit_function_score2, expanded_df)

# Confidence intervals (95%)
ci_score1 <- c(results_score1$mean - 1.96*results_score1$se, results_score1$mean + 1.96*results_score1$se)
ci_score2 <- c(results_score2$mean - 1.96*results_score2$se, results_score2$mean + 1.96*results_score2$se)

# Plot using ggplot2
library(ggplot2)

df_cindex <- data.frame(
  Score = c( "MSGene","30 Year"),
  Cindex = c(results_score1$mean, results_score2$mean),
  ymin = c(ci_score1[1], ci_score2[1]),
  ymax = c(ci_score1[2], ci_score2[2])
)

p <- ggplot(df_cindex, aes(x = Score, y = Cindex,fill=Score)) +
  geom_bar(stat = "identity", position = position_dodge()) +
  geom_errorbar(aes(ymin=ymin, ymax=ymax), width=0.1, position=position_dodge(0.9)) +
  ylim(0,0.8 ) +
  labs(
    title = "Comparison of Predictive Performance",
    subtitle = "Using Bootstrap 95% CI for C-index (Concordance Index)",
    y = "C-index Value",
    x = ""
  ) +
  theme_classic()+scale_fill_aaas()

print(p)


####

```



```{r}
library(survival)
#ri=sample(unique(expanded_df$id),1000)
#sub=expanded_df[expanded_df$id%in%ri,]
cox_model <- coxph(Surv(start, stop, event) ~ score1, data = expanded_df,x = T)
library(pec)
### create a vector of predicted survival for every individual based on their profile at that time
time_points <- c(41:80)
brier.score=matrix(NA,nrow=2,ncol=length(time_points))
surv_probs <- predictSurvProb(object = cox_model,newdata=expanded_df, times=time_points)
colnames(surv_probs)=time_points
df=cbind(expanded_df,surv_probs)
dgood=df[df$age%in%time_points,]

for(j in 1:length(time_points)){
    dat=dgood[dgood$age==time_points[j],]
    surv=ifelse(dat$event==0,1,0)
    psurv=dat[,(j+7)]
    print(mean((surv-psurv)^2))
    brier.score[1,j]=mean((surv-psurv)^2)
    
    
}

rm(cox_model)
rm(surv_probs)
rm(df)
rm(dat)
cox_model <- coxph(Surv(start, stop, event) ~ score2, data = expanded_df,x = T)
time_points <- c(41:80)
### create a vector of predicted survival for every individual based on their profile at that time over a variety of time points

surv_probs <- predictSurvProb(object = cox_model,newdata=expanded_df, times=time_points)


colnames(surv_probs)=time_points
df=cbind(expanded_df,surv_probs)
dgood=df[df$age%in%time_points,]

for(j in 1:length(time_points)){
    dat=dgood[dgood$age==time_points[j],]
    surv=ifelse(dat$event==0,1,0)
    psurv=dat[,(j+7)]
    print(mean((surv-psurv)^2))
    brier.score[2,j]=mean((surv-psurv)^2)
    
}

bs=data.frame(t(brier.score))
bs$Age=time_points
colnames(bs)=c("MSGene","FRS30y","Time")
bs=melt(bs,id.vars = "Time")
ggplot(bs,aes(x=Time,y=value,fill=variable))+geom_bar(stat = "identity",position = "dodge")+labs(x="Time Point",y="Brier Score",fill="Score")+theme_classic()


###

cox_model <- coxph(Surv(start, stop, event) ~ score2, data = expanded_df,x = T)
time_points <- c(41:80)
### create a vector of predicted survival for every individual based on their profile at that time over a variety of time points
surv_probs <- predictSurvProb(object = cox_model,newdata=expanded_df, times=time_points)
colnames(surv_probs)=time_points
df=cbind(expanded_df,surv_probs)
dgood=df[df$age%in%time_points,]

dfevent=test[,c("identifier","Cad_0_Any","Cad_0_censor_age")]
m=merge(dgood[,c("id","age","80")],dfevent,by.x="id",by.y="identifier",all.x =T)
m$surv=ifelse(m$Cad_0_Any==1,1,0)

for(j in 1:length(time_points)){
    dat=m[m$age==time_points[j],]
    surv=dat$surv
    psurv=dat[,"80"]
    print(mean((surv-psurv)^2))
    brier.score[2,j]=mean((surv-psurv)^2)
    
}



###


cox_model <- coxph(Surv(start, stop, event) ~ score1, data = expanded_df,x = T)
time_points <- c(41:80)
### create a vector of predicted survival for every individual based on their profile at that time over a variety of time points
surv_probs <- predictSurvProb(object = cox_model,newdata=expanded_df, times=time_points)
colnames(surv_probs)=time_points
df=cbind(expanded_df,surv_probs)
dgood=df[df$age%in%time_points,]

dfevent=test[,c("identifier","Cad_0_Any","Cad_0_censor_age")]
m=merge(dgood[,c("id","age","80")],dfevent,by.x="id",by.y="identifier",all.x =T)
m$surv=ifelse(m$Cad_0_Any==1,1,0)

for(j in 1:length(time_points)){
    dat=m[m$age==time_points[j],]
    surv=dat$surv
    psurv=dat[,"80"]
    print(mean((surv-psurv)^2))
    brier.score[1,j]=mean((surv-psurv)^2)
    
}


bs=data.frame(t(brier.score))
bs$Age=time_points
colnames(bs)=c("MSGene","FRS30y","Time")
bs=melt(bs,id.vars = "Time")
ggplot(bs,aes(x=Time,y=value,fill=variable))+geom_bar(stat = "identity",position = "dodge")+labs(x="Time Point",y="Brier Score",fill="Score")+theme_classic()

```

