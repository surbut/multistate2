<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />



<meta name="date" content="2023-12-25" />

<title>Advances in time dependent modeling</title>

<script src="site_libs/header-attrs-2.25/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/jqueryui-1.13.2/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/textmate.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/font-awesome-6.4.2/css/all.min.css" rel="stylesheet" />
<link href="site_libs/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet" />

<link rel="icon" href="https://github.com/workflowr/workflowr-assets/raw/main/img/reproducible.png">
<!-- Add a small amount of space between sections. -->
<style type="text/css">
div.section {
  padding-top: 12px;
}
</style>



<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>









<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark the anchor link active (and if it's in a dropdown, also mark that active)
  var dropdown = menuAnchor.closest('li.dropdown');
  if (window.bootstrap) { // Bootstrap 4+
    menuAnchor.addClass('active');
    dropdown.find('> .dropdown-toggle').addClass('active');
  } else { // Bootstrap 3
    menuAnchor.parent().addClass('active');
    dropdown.addClass('active');
  }

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before, .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "\e259";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "\e258";
  font-family: 'Glyphicons Halflings';
  border: none;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">multistate2</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li>
  <a href="about.html">About</a>
</li>
<li>
  <a href="license.html">License</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/surbut/multistate2">
    <span class="fab fa-github"></span>
     
    Source code
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">Advances in time dependent modeling</h1>
<h4 class="date">2023-12-25</h4>

</div>


<p>
<button type="button" class="btn btn-default btn-workflowr btn-workflowr-report" data-toggle="collapse" data-target="#workflowr-report">
<span class="glyphicon glyphicon-list" aria-hidden="true"></span>
workflowr <span class="glyphicon glyphicon-exclamation-sign text-danger"
aria-hidden="true"></span>
</button>
</p>
<div id="workflowr-report" class="collapse">
<ul class="nav nav-tabs">
<li class="active">
<a data-toggle="tab" href="#summary">Summary</a>
</li>
<li>
<a data-toggle="tab" href="#checks"> Checks <span
class="glyphicon glyphicon-exclamation-sign text-danger"
aria-hidden="true"></span> </a>
</li>
<li>
<a data-toggle="tab" href="#versions">Past versions</a>
</li>
</ul>
<div class="tab-content">
<div id="summary" class="tab-pane fade in active">
<p>
<strong>Last updated:</strong> 2023-12-29
</p>
<p>
<strong>Checks:</strong> <span
class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> 6
<span class="glyphicon glyphicon-exclamation-sign text-danger"
aria-hidden="true"></span> 1
</p>
<p>
<strong>Knit directory:</strong> <code>~/multistate2/</code> <span
class="glyphicon glyphicon-question-sign" aria-hidden="true"
title="This is the local directory in which the code in this file was executed.">
</span>
</p>
<p>
This reproducible <a href="https://rmarkdown.rstudio.com">R Markdown</a>
analysis was created with <a
  href="https://github.com/workflowr/workflowr">workflowr</a> (version
1.7.1). The <em>Checks</em> tab describes the reproducibility checks
that were applied when the results were created. The <em>Past
versions</em> tab lists the development history.
</p>
<hr>
</div>
<div id="checks" class="tab-pane fade">
<div id="workflowr-checks" class="panel-group">
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongRMarkdownfilestronguncommittedchanges">
<span class="glyphicon glyphicon-exclamation-sign text-danger"
aria-hidden="true"></span> <strong>R Markdown file:</strong> uncommitted
changes </a>
</p>
</div>
<div id="strongRMarkdownfilestronguncommittedchanges"
class="panel-collapse collapse">
<div class="panel-body">
<p>The R Markdown file has unstaged changes. To know which version of
the R Markdown file created these results, you’ll want to first commit
it to the Git repo. If you’re still working on the analysis, you can
ignore this warning. When you’re finished, you can run
<code>wflow_publish</code> to commit the R Markdown file and build the
HTML.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongEnvironmentstrongempty">
<span class="glyphicon glyphicon-ok text-success"
aria-hidden="true"></span> <strong>Environment:</strong> empty </a>
</p>
</div>
<div id="strongEnvironmentstrongempty" class="panel-collapse collapse">
<div class="panel-body">
<p>Great job! The global environment was empty. Objects defined in the
global environment can affect the analysis in your R Markdown file in
unknown ways. For reproduciblity it’s best to always run the code in an
empty environment.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongSeedstrongcodesetseed20230211code">
<span class="glyphicon glyphicon-ok text-success"
aria-hidden="true"></span> <strong>Seed:</strong>
<code>set.seed(20230211)</code> </a>
</p>
</div>
<div id="strongSeedstrongcodesetseed20230211code"
class="panel-collapse collapse">
<div class="panel-body">
<p>The command <code>set.seed(20230211)</code> was run prior to running
the code in the R Markdown file. Setting a seed ensures that any results
that rely on randomness, e.g. subsampling or permutations, are
reproducible.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongSessioninformationstrongrecorded">
<span class="glyphicon glyphicon-ok text-success"
aria-hidden="true"></span> <strong>Session information:</strong>
recorded </a>
</p>
</div>
<div id="strongSessioninformationstrongrecorded"
class="panel-collapse collapse">
<div class="panel-body">
<p>Great job! Recording the operating system, R version, and package
versions is critical for reproducibility.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongCachestrongnone">
<span class="glyphicon glyphicon-ok text-success"
aria-hidden="true"></span> <strong>Cache:</strong> none </a>
</p>
</div>
<div id="strongCachestrongnone" class="panel-collapse collapse">
<div class="panel-body">
<p>Nice! There were no cached chunks for this analysis, so you can be
confident that you successfully produced the results during this
run.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongFilepathsstrongrelative">
<span class="glyphicon glyphicon-ok text-success"
aria-hidden="true"></span> <strong>File paths:</strong> relative </a>
</p>
</div>
<div id="strongFilepathsstrongrelative" class="panel-collapse collapse">
<div class="panel-body">
<p>Great job! Using relative paths to the files within your workflowr
project makes it easier to run your code on other machines.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongRepositoryversionstrongahrefhttpsgithubcomsurbutmultistate2tree1c11be69df756c2f08c38eab3a752a7b3f049506targetblank1c11be6a">
<span class="glyphicon glyphicon-ok text-success"
aria-hidden="true"></span> <strong>Repository version:</strong>
<a href="https://github.com/surbut/multistate2/tree/1c11be69df756c2f08c38eab3a752a7b3f049506" target="_blank">1c11be6</a>
</a>
</p>
</div>
<div
id="strongRepositoryversionstrongahrefhttpsgithubcomsurbutmultistate2tree1c11be69df756c2f08c38eab3a752a7b3f049506targetblank1c11be6a"
class="panel-collapse collapse">
<div class="panel-body">
<p>
Great! You are using Git for version control. Tracking code development
and connecting the code version to the results is critical for
reproducibility.
</p>
<p>
The results in this page were generated with repository version
<a href="https://github.com/surbut/multistate2/tree/1c11be69df756c2f08c38eab3a752a7b3f049506" target="_blank">1c11be6</a>.
See the <em>Past versions</em> tab to see a history of the changes made
to the R Markdown and HTML files.
</p>
<p>
Note that you need to be careful to ensure that all relevant files for
the analysis have been committed to Git prior to generating the results
(you can use <code>wflow_publish</code> or
<code>wflow_git_commit</code>). workflowr only checks the R Markdown
file, but you know if there are other scripts or data files that it
depends on. Below is the status of the Git repository when the results
were generated:
</p>
<pre><code>
Ignored files:
    Ignored:    .DS_Store
    Ignored:    .Rproj.user/
    Ignored:    analysis/.DS_Store
    Ignored:    code/.DS_Store
    Ignored:    data/
    Ignored:    lesliepics/.DS_Store
    Ignored:    output/
    Ignored:    plots/.DS_Store

Unstaged changes:
    Modified:   analysis/playing_withtopic.Rmd

</code></pre>
<p>
Note that any generated files, e.g. HTML, png, CSS, etc., are not
included in this status report because it is ok for generated content to
have uncommitted changes.
</p>
</div>
</div>
</div>
</div>
<hr>
</div>
<div id="versions" class="tab-pane fade">

<p>
These are the previous versions of the repository in which changes were
made to the R Markdown (<code>analysis/playing_withtopic.Rmd</code>) and
HTML (<code>docs/playing_withtopic.html</code>) files. If you’ve
configured a remote Git repository (see <code>?wflow_git_remote</code>),
click on the hyperlinks in the table below to view the files as they
were in that past version.
</p>
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
File
</th>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
<th>
Message
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
Rmd
</td>
<td>
<a href="https://github.com/surbut/multistate2/blob/1c11be69df756c2f08c38eab3a752a7b3f049506/analysis/playing_withtopic.Rmd" target="_blank">1c11be6</a>
</td>
<td>
Sarah Urbut
</td>
<td>
2023-12-28
</td>
<td>
Update
</td>
</tr>
<tr>
<td>
html
</td>
<td>
<a href="https://rawcdn.githack.com/surbut/multistate2/1c11be69df756c2f08c38eab3a752a7b3f049506/docs/playing_withtopic.html" target="_blank">1c11be6</a>
</td>
<td>
Sarah Urbut
</td>
<td>
2023-12-28
</td>
<td>
Update
</td>
</tr>
<tr>
<td>
Rmd
</td>
<td>
<a href="https://github.com/surbut/multistate2/blob/8b0f4416d606f7afd838703627874aba1a34f2af/analysis/playing_withtopic.Rmd" target="_blank">8b0f441</a>
</td>
<td>
Sarah Urbut
</td>
<td>
2023-12-27
</td>
<td>
Update
</td>
</tr>
<tr>
<td>
html
</td>
<td>
<a href="https://rawcdn.githack.com/surbut/multistate2/8b0f4416d606f7afd838703627874aba1a34f2af/docs/playing_withtopic.html" target="_blank">8b0f441</a>
</td>
<td>
Sarah Urbut
</td>
<td>
2023-12-27
</td>
<td>
Update
</td>
</tr>
<tr>
<td>
Rmd
</td>
<td>
<a href="https://github.com/surbut/multistate2/blob/4d2ac756d3a856171b64cc96406171bce2918d39/analysis/playing_withtopic.Rmd" target="_blank">4d2ac75</a>
</td>
<td>
Sarah Urbut
</td>
<td>
2023-12-26
</td>
<td>
Update
</td>
</tr>
<tr>
<td>
html
</td>
<td>
<a href="https://rawcdn.githack.com/surbut/multistate2/4d2ac756d3a856171b64cc96406171bce2918d39/docs/playing_withtopic.html" target="_blank">4d2ac75</a>
</td>
<td>
Sarah Urbut
</td>
<td>
2023-12-26
</td>
<td>
Update
</td>
</tr>
<tr>
<td>
Rmd
</td>
<td>
<a href="https://github.com/surbut/multistate2/blob/e83fb18a5cdd23e13b11f66a5137d2db23ae3368/analysis/playing_withtopic.Rmd" target="_blank">e83fb18</a>
</td>
<td>
Sarah Urbut
</td>
<td>
2023-12-26
</td>
<td>
Update
</td>
</tr>
<tr>
<td>
html
</td>
<td>
<a href="https://rawcdn.githack.com/surbut/multistate2/e83fb18a5cdd23e13b11f66a5137d2db23ae3368/docs/playing_withtopic.html" target="_blank">e83fb18</a>
</td>
<td>
Sarah Urbut
</td>
<td>
2023-12-26
</td>
<td>
Update
</td>
</tr>
<tr>
<td>
Rmd
</td>
<td>
<a href="https://github.com/surbut/multistate2/blob/0e5a222970387b0c1ee8756e8712f65825e150f3/analysis/playing_withtopic.Rmd" target="_blank">0e5a222</a>
</td>
<td>
Sarah Urbut
</td>
<td>
2023-12-26
</td>
<td>
Update
</td>
</tr>
<tr>
<td>
Rmd
</td>
<td>
<a href="https://github.com/surbut/multistate2/blob/fec5236c0372d21bffd36758eab351ef8e27f85b/analysis/playing_withtopic.Rmd" target="_blank">fec5236</a>
</td>
<td>
Sarah Urbut
</td>
<td>
2023-12-25
</td>
<td>
Update
</td>
</tr>
<tr>
<td>
Rmd
</td>
<td>
<a href="https://github.com/surbut/multistate2/blob/b297d53febeb50e785020ae47ba77ed1d0493a9d/analysis/playing_withtopic.Rmd" target="_blank">b297d53</a>
</td>
<td>
Sarah Urbut
</td>
<td>
2023-12-25
</td>
<td>
Update
</td>
</tr>
<tr>
<td>
html
</td>
<td>
<a href="https://rawcdn.githack.com/surbut/multistate2/b297d53febeb50e785020ae47ba77ed1d0493a9d/docs/playing_withtopic.html" target="_blank">b297d53</a>
</td>
<td>
Sarah Urbut
</td>
<td>
2023-12-25
</td>
<td>
Update
</td>
</tr>
</tbody>
</table>
</div>
<hr>
</div>
</div>
</div>
<div id="overview-of-topic-modeling" class="section level2">
<h2>Overview of Topic Modeling</h2>
<p>We first lay out a basic topic model without any accounting for
time.</p>
<p>In this model, we have a number of people, M.</p>
<p>Each individual has a number of diagnoses, N_{i=1M}.We will simulate
this as a poisson RV with mean of 10 diagnoses per patient.</p>
<p>There are a total number of <span class="math inline">\(N=\sum
_{i=1}^{M}N_{i}\)</span> diagnoses over all individuals.</p>
<p>There are a total of <span class="math inline">\(V\)</span> disease
codes entirely.</p>
<p>For each of the M individuals, there exists a distribution over K
topics, <span class="math inline">\(\theta_{i}\)</span>.</p>
<p>This topic distribution for a given individual, <span
class="math inline">\(\theta_i\)</span> will be sparsely simulated so
individuals are loaded on a minimal number of topics using a random
dirichlet with <span class="math inline">\(\alpha\)</span> = [0.1,…K]
.</p>
<p>For each of the K topics, there is a distribution on V diseases.
There are a total of V diseases. This parameter <span
class="math inline">\(\phi_k\)</span>, over diseases, is simulated also
according to a sparse dirichlet, this time with hyperparameter <span
class="math inline">\(\beta\)</span> for example also = 0.1_RV</p>
<p>Here we allow that each topic has a special ‘topic specific’ disease
enrichment, such that for a select number d of randomly sampled
diseases, here d=10, is (V-d)/V with the remaining = 1/V.</p>
</div>
<div id="generative-model" class="section level1">
<h1>Generative model</h1>
<p>Now each disease arises from a topic (there can be overlap such that
one disease can be featured in several topics) with latent indicator
<span class="math inline">\(z_{i=1..M,j=1:Ni}\)</span> with an integer
from 1:K.</p>
<p><span class="math inline">\(1:Ni\)</span> here represents the fact
that an individual can have up to Ni diagnoses, so that <span
class="math inline">\(Z\)</span> is a giant vector of length N.</p>
<p>According to the assigned topic (1:K) for that diagnosis, the
probability of the given diagnosis is drawn according to <span
class="math inline">\(\phi_{kd}\)</span></p>
</div>
<div id="table-of-variables" class="section level1">
<h1>Table of Variables</h1>
<table>
<colgroup>
<col width="33%" />
<col width="33%" />
<col width="33%" />
</colgroup>
<thead>
<tr class="header">
<th>Variable</th>
<th>Type</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>K</td>
<td>integer</td>
<td>number of topics (e.g. 50)</td>
</tr>
<tr class="even">
<td>V</td>
<td>integer</td>
<td>number of diseases in the vocabulary (e.g. 50,000 or 1,000,000)</td>
</tr>
<tr class="odd">
<td>M</td>
<td>integer</td>
<td>number of persons</td>
</tr>
<tr class="even">
<td><span class="math inline">\(N_{i_{1..M}}\)</span></td>
<td>integer</td>
<td>number of diseases in person <span
class="math inline">\(i\)</span></td>
</tr>
<tr class="odd">
<td>N</td>
<td>integer</td>
<td>total number of diseases in all persons; sum of all <span
class="math inline">\(N_d\)</span> values, i.e. <span
class="math inline">\(N = \sum_{i=1}^{M} N_i\)</span></td>
</tr>
<tr class="even">
<td><span class="math inline">\(\alpha_{k_{1..K}}\)</span></td>
<td>positive real</td>
<td>prior weight of topic <span class="math inline">\(k\)</span> in a
person; usually the same for all topics; normally a number less than 1,
e.g. 0.1, to prefer sparse topic distributions, i.e. few topics per
person</td>
</tr>
<tr class="odd">
<td><span class="math inline">\(\alpha\)</span></td>
<td>K-dimensional vector of positive reals</td>
<td>collection of all <span class="math inline">\(\alpha_k\)</span>
values, viewed as a single vector</td>
</tr>
<tr class="even">
<td><span class="math inline">\(\beta_{w_{1..V}}\)</span></td>
<td>positive real</td>
<td>prior weight of disease <span class="math inline">\(w\)</span> in a
topic; usually the same for all diseases; normally a number much less
than 1, e.g. 0.001, to strongly prefer sparse disease distributions,
i.e. few diseases per topic</td>
</tr>
<tr class="odd">
<td><span class="math inline">\(\beta\)</span></td>
<td>V-dimensional vector of positive reals</td>
<td>collection of all <span class="math inline">\(\beta_w\)</span>
values, viewed as a single vector</td>
</tr>
<tr class="even">
<td><span class="math inline">\(\phi_{k_{1..K},w_{1..V}}\)</span></td>
<td>probability (real number between 0 and 1)</td>
<td>probability of disease <span class="math inline">\(w\)</span>
occurring in topic <span class="math inline">\(k\)</span></td>
</tr>
<tr class="odd">
<td><span class="math inline">\(\Phi_{k_{1..K}}\)</span></td>
<td>V-dimensional vector of probabilities, which must sum to 1</td>
<td>distribution of diseases in topic <span
class="math inline">\(k\)</span></td>
</tr>
<tr class="even">
<td><span class="math inline">\(\theta_{d_{1..M},k_{1..K}}\)</span></td>
<td>probability (real number between 0 and 1)</td>
<td>probability of topic <span class="math inline">\(k\)</span>
occurring in person <span class="math inline">\(d\)</span></td>
</tr>
<tr class="odd">
<td><span class="math inline">\(\Theta_{d_{1..M}}\)</span></td>
<td>K-dimensional vector of probabilities, which must sum to 1</td>
<td>distribution of topics in person <span
class="math inline">\(d\)</span></td>
</tr>
<tr class="even">
<td><span class="math inline">\(z_{d_{1..M},w_{1..N_d}}\)</span></td>
<td>integer between 1 and K</td>
<td>identity of topic of disease <span class="math inline">\(w\)</span>
in person <span class="math inline">\(d\)</span></td>
</tr>
<tr class="odd">
<td>Z</td>
<td>N-dimensional vector of integers between 1 and K</td>
<td>identity of topic of all diseases in all persons</td>
</tr>
<tr class="even">
<td><span class="math inline">\(w_{d_{1..M},w_{1..N_d}}\)</span></td>
<td>integer between 1 and V</td>
<td>identity of disease <span class="math inline">\(w\)</span> in person
<span class="math inline">\(d\)</span></td>
</tr>
<tr class="odd">
<td>W</td>
<td>N-dimensional vector of integers between 1 and V</td>
<td>identity of all diseases in all persons</td>
</tr>
</tbody>
</table>
<div id="simulation" class="section level2">
<h2>Simulation</h2>
<pre class="r"><code>set.seed(123)
library(rBeta2009)
library(ggplot2)
library(reshape2)
library(splines)

# number of people
M=100

# number of topics
K=5

## number of diagnoses per patient, mean of 10 diagnoses per patient
Nd=rpois(M,lambda = 10)

## total numer of diagnoses
N=sum(Nd)

# number of disease total
V=300</code></pre>
<pre class="r"><code>## make sparse so that most mass concentrated on one topic 
alpha=rep(0.1,K)

## make sparse so that most mass concentrated on one disease 
beta=rep(1/V,V)

## distribution of topics per pt
theta=rdirichlet(M,shape = alpha)
dim(theta)</code></pre>
<pre><code>[1] 100   5</code></pre>
<pre class="r"><code>## distribution of diseases per topic, load heavily on some
# d will be number of strong disease per topic

d=10
topic_spec_disease=matrix(sample(V,size = K*d),nrow=K,byrow = T)
phi=rdirichlet(K,shape = beta)

for (k in 1:K) {
    for (v in 1:V) {
        # Assign higher probabilities to certain diseases for each topic
        # Placeholder: Assigning higher weights to some diseases
        if (v%in%topic_spec_disease[k,]) {
            beta[v] &lt;- (V-d)/V
        } else {
            beta[v] &lt;- beta[v]
        }
    }
    phi[k, ] &lt;- rdirichlet(1, beta)
}

dim(phi)</code></pre>
<pre><code>[1]   5 300</code></pre>
<pre class="r"><code># check to make sure topic specific disease highly loaded
which(order(phi[1,],decreasing = T)%in%topic_spec_disease[1,])</code></pre>
<pre><code> [1]  1  2  3  4  5  6  7  8  9 10</code></pre>
<pre class="r"><code>## decide if we want all his or her diseases to come from same topic, no repeat diangoses
# disease &lt;- list() # Initialize the list outside the loop
# for(i in 1:M){
#   disease[[i]] &lt;- vector(&quot;list&quot;, Nd[i]) # Initialize the ith list
#   for(j in 1:Nd[i]){
#     zij &lt;- which(rmultinom(1, size = 1, prob = theta[i,]) == 1)
#     wij &lt;- which(rmultinom(1, 1, prob = phi[zij,]) == 1)
#     disease[[i]][j] &lt;- wij # diagnose your patient with some badness 
#   }
# }


# recall we also want no diseases to come from same topic
disease &lt;- list()  # Initialize the list outside the loop

for (i in 1:M) {
  # Check if the patient has any diagnoses to assign
  if (Nd[i] &gt; 0) {
    disease[[i]] &lt;- vector(&quot;list&quot;, Nd[i])  # Initialize the ith list if diagnoses are to be assigned
    assigned_diagnoses &lt;- integer(0)  # Keep track of diagnoses already assigned to this patient

    for (j in 1:Nd[i]) {
      zij &lt;- which(rmultinom(1, size = 1, prob = theta[i,]) == 1)
    
      # Exclude already assigned diagnoses when selecting a new one
      valid_diagnoses &lt;- setdiff(1:V, assigned_diagnoses)
      
      # normalize so sums to 1
      prob_valid_diagnoses &lt;- phi[zij, valid_diagnoses] / sum(phi[zij, valid_diagnoses])

      if (length(valid_diagnoses) &gt; 0) {
        wij &lt;- sample(valid_diagnoses, 1, prob = prob_valid_diagnoses)
        disease[[i]][[j]] &lt;- wij
        assigned_diagnoses &lt;- c(assigned_diagnoses, wij)  # Update the list of assigned diagnoses
      } else {
        # Handle the case where all diagnoses have been assigned
        # Placeholder: Assign a random diagnosis or handle as per your model&#39;s requirements
        disease[[i]][[j]] &lt;- sample(1:V, 1)
      }
    }
  } else {
    disease[[i]] &lt;- NULL  # Assign NULL or an appropriate placeholder for patients with no diagnoses
  }
}</code></pre>
</div>
</div>
<div id="visualizing-basic-simulation" class="section level1">
<h1>Visualizing Basic Simulation</h1>
<p>Here we whow the distirbtuion of <span
class="math inline">\(theta\)</span> and <span
class="math inline">\(phi\)</span> to demonstrate that individuals are
minimally loaded on one topic and each topic is minimally loaded on a
few diseases:</p>
<p><img src="figure/playing_withtopic.Rmd/unnamed-chunk-1-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-unnamed-chunk-1-1">
Past versions of unnamed-chunk-1-1.png
</button>
</p>
<div id="fig-unnamed-chunk-1-1" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/surbut/multistate2/blob/e83fb18a5cdd23e13b11f66a5137d2db23ae3368/docs/figure/playing_withtopic.Rmd/unnamed-chunk-1-1.png" target="_blank">e83fb18</a>
</td>
<td>
Sarah Urbut
</td>
<td>
2023-12-26
</td>
</tr>
<tr>
<td>
<a href="https://github.com/surbut/multistate2/blob/b297d53febeb50e785020ae47ba77ed1d0493a9d/docs/figure/playing_withtopic.Rmd/unnamed-chunk-1-1.png" target="_blank">b297d53</a>
</td>
<td>
Sarah Urbut
</td>
<td>
2023-12-25
</td>
</tr>
</tbody>
</table>
</div>
</div>
<p><img src="figure/playing_withtopic.Rmd/unnamed-chunk-1-2.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-unnamed-chunk-1-2">
Past versions of unnamed-chunk-1-2.png
</button>
</p>
<div id="fig-unnamed-chunk-1-2" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/surbut/multistate2/blob/e83fb18a5cdd23e13b11f66a5137d2db23ae3368/docs/figure/playing_withtopic.Rmd/unnamed-chunk-1-2.png" target="_blank">e83fb18</a>
</td>
<td>
Sarah Urbut
</td>
<td>
2023-12-26
</td>
</tr>
<tr>
<td>
<a href="https://github.com/surbut/multistate2/blob/b297d53febeb50e785020ae47ba77ed1d0493a9d/docs/figure/playing_withtopic.Rmd/unnamed-chunk-1-2.png" target="_blank">b297d53</a>
</td>
<td>
Sarah Urbut
</td>
<td>
2023-12-25
</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>But overall, `we can see that topic specific diseases have a higher
<span class="math inline">\(phi\)</span> than those that don’t:</p>
<p><img src="figure/playing_withtopic.Rmd/unnamed-chunk-2-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-unnamed-chunk-2-1">
Past versions of unnamed-chunk-2-1.png
</button>
</p>
<div id="fig-unnamed-chunk-2-1" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/surbut/multistate2/blob/e83fb18a5cdd23e13b11f66a5137d2db23ae3368/docs/figure/playing_withtopic.Rmd/unnamed-chunk-2-1.png" target="_blank">e83fb18</a>
</td>
<td>
Sarah Urbut
</td>
<td>
2023-12-26
</td>
</tr>
<tr>
<td>
<a href="https://github.com/surbut/multistate2/blob/b297d53febeb50e785020ae47ba77ed1d0493a9d/docs/figure/playing_withtopic.Rmd/unnamed-chunk-2-1.png" target="_blank">b297d53</a>
</td>
<td>
Sarah Urbut
</td>
<td>
2023-12-25
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="observed-data" class="section level1">
<h1>Observed data</h1>
<p>Now, we want to simulate the observed diagnoses <span
class="math inline">\(w_{ij}\)</span> for sample individuals</p>
<pre class="r"><code># Assuming &#39;disease&#39; is your list of diagnoses for each person from above
# Convert &#39;disease&#39; list into a data frame for plotting

disease_data &lt;- data.frame(person = rep(seq_along(disease), sapply(disease, length)),
                        disease = unlist(disease))

# Now create the plot
random_peeps=sample(M,size = 5)
ggplot(disease_data[disease_data$person%in%random_peeps,], aes(x = disease,fill=as.factor(disease))) +
  geom_bar() +
  facet_wrap(~ person, scales = &quot;free_x&quot;) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = &quot;Disease&quot;, y = &quot;Frequency&quot;, title = &quot;Disease Distribution per Person&quot;,fill=&quot;Disease&quot;)+theme_classic()</code></pre>
<p><img src="figure/playing_withtopic.Rmd/unnamed-chunk-3-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-unnamed-chunk-3-1">
Past versions of unnamed-chunk-3-1.png
</button>
</p>
<div id="fig-unnamed-chunk-3-1" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/surbut/multistate2/blob/e83fb18a5cdd23e13b11f66a5137d2db23ae3368/docs/figure/playing_withtopic.Rmd/unnamed-chunk-3-1.png" target="_blank">e83fb18</a>
</td>
<td>
Sarah Urbut
</td>
<td>
2023-12-26
</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>We can see that most people have on average 10 diagnoses from a set
of V = 300. The people we choose, 92, 94, 68, 3, 59, were heavily loaded
on the following topics:</p>
<p>1, 3, 4, 4, 1</p>
<p>For example, our first person 92 has 15 diagnoses. He is most heavily
loaded on 1. In turn this topic was chosen to have concentration of
<span class="math inline">\(phi_{k}\)</span> at 4, 35, 238, 210, 266,
12, 128, 259, 282, 204 these disease.</p>
<p>We can see that a high proportion of his diagnoses emanate from one
of these topic-specific diseases:</p>
<ol style="list-style-type: decimal">
<li></li>
</ol>
</div>
<div id="adding-a-time-element" class="section level1">
<h1>Adding a time element</h1>
<p>Now, in McVean et al, instead of having only one V vector with N_{i}
sparse indicators in <span class="math inline">\(\phi_k\)</span> per
topic, there are <span class="math inline">\(\phi_{kt}\)</span> for a
time and topic specific diagnosis distribution.</p>
<p>Easy enough! Recall before we had a matrix that was KxV for the
disease distribution per topic.</p>
<p>Now we will initialize an <em>array</em> that is KxVxT that has a
disease distribution per topic per time.</p>
<p>The trick is that these need to be somewhat continuous – you can’t go
from a 100% probability of hypertension to 0 overnight.</p>
<p>So … they use a natural spline. Here, we introduce a scaled bspline
basis (with a knot at 0.5 and 3 degrees) that is scaled by the <span
class="math inline">\(\phi\)</span> we just described inorder to
introduce both continuity and preserve sparsity.</p>
<pre class="r"><code>K &lt;- length(alpha)  # Number of topics
V &lt;- length(beta)   # Number of diagnoses
T &lt;- 100            # Number of time points
time_points &lt;- seq(0, 100, length.out = T)
phi &lt;- array(dim = c(K, V, T))
beta=rep(1/V,V)
for (k in 1:K) {
    for (v in 1:V) {
        # Assign higher probabilities to certain diseases for each topic
        # Placeholder: Assigning higher weights to some diseases
        if (v%in%topic_spec_disease[k,]) {
            beta[v] &lt;- (V-d)/V
        } else {
            beta[v] &lt;- beta[v]
        }
    }
    phi[k,,1 ] &lt;- rdirichlet(1, beta)
}



# Normalize initial phi
for (k in 1:K) {
    phi[k, , 1] &lt;- phi[k, , 1] / sum(phi[k, , 1])
}

summary(rowSums(phi[,,1]))</code></pre>
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
      1       1       1       1       1       1 </code></pre>
<pre class="r"><code>all_normalized &lt;- all(apply(phi[, , 1], 1, function(x) abs(sum(x) - 1) &lt; .Machine$double.eps^0.5))
print(all_normalized)  # Should print TRUE if all are normalized</code></pre>
<pre><code>[1] TRUE</code></pre>
<pre class="r"><code>degree=3
knots=0.5

## in McVean they have a set of spline functions across time for each of the KxV diseases, so we choose each set of coefficients randomly for each disease

# Apply spline transformation with positive coefficients
for (k in 1:K) {
     
    for (v in 1:V) {
      # First, generate a disease specific B-spline basis
    bspline_basis &lt;- bs(time_points, knots = knots, degree = degree, intercept = TRUE)
   
        # Generate positive coefficients for the spline, ensuring they are small enough
        # to not dominate the topic-specific diseases
        coef &lt;- runif(length(knots) + degree + 1, min = 0, max = 0.5)
        
        # Calculate spline values ensuring they are non-negative
        spline_values &lt;- bspline_basis %*% coef

        # For topic-specific diseases, scale the spline values based on initial phi
        # For non-topic-specific diseases, dampen the effect to keep them low
        if (v %in% topic_spec_disease[k,]) {
            scaled_spline_values &lt;- spline_values * phi[k, v, 1] / max(spline_values)
        } else {
            # Apply a dampening factor to non-topic specific diseases
            dampening_factor &lt;- 0.01
            scaled_spline_values &lt;- spline_values * dampening_factor * phi[k, v, 1] / max(spline_values)
        }

        # Store the scaled spline values
        phi[k, v, ] &lt;- scaled_spline_values
    }
}

matplot(bspline_basis)</code></pre>
<p><img src="figure/playing_withtopic.Rmd/simulatedphi-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-simulatedphi-1">
Past versions of simulatedphi-1.png
</button>
</p>
<div id="fig-simulatedphi-1" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/surbut/multistate2/blob/1c11be69df756c2f08c38eab3a752a7b3f049506/docs/figure/playing_withtopic.Rmd/simulatedphi-1.png" target="_blank">1c11be6</a>
</td>
<td>
Sarah Urbut
</td>
<td>
2023-12-28
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="normalization" class="section level1">
<h1>Normalization</h1>
<p>We need to normalize phi over time after this spline transfomration
to ensure a proper distribution:</p>
<pre class="r"><code># Normalize phi over time after spline transformation
for (t in 1:T) {
    for (k in 1:K) {
        sum_phi_kt &lt;- sum(phi[k, , t])
        if (sum_phi_kt &gt; 0) {
            phi[k, , t] &lt;- phi[k, , t] / sum_phi_kt
        }
    }
}

# Check normalization for each time point
all_normalized &lt;- TRUE
for (t in 1:T) {
    if (!all(apply(phi[, , t], 1, function(x) abs(sum(x) - 1) &lt; .Machine$double.eps^0.5))) {
        all_normalized &lt;- FALSE
        break
    }
}
print(all_normalized)  # Should print TRUE if all are normalized```</code></pre>
<pre><code>[1] TRUE</code></pre>
<p>Now <span class="math inline">\(\phi\)</span> is the array of
diseases x topics x time, so for a given topic, this should be
continous. Let’s look at a sample topic with a few diseases to
check:</p>
<p><img src="figure/playing_withtopic.Rmd/unnamed-chunk-5-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-unnamed-chunk-5-1">
Past versions of unnamed-chunk-5-1.png
</button>
</p>
<div id="fig-unnamed-chunk-5-1" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/surbut/multistate2/blob/1c11be69df756c2f08c38eab3a752a7b3f049506/docs/figure/playing_withtopic.Rmd/unnamed-chunk-5-1.png" target="_blank">1c11be6</a>
</td>
<td>
Sarah Urbut
</td>
<td>
2023-12-28
</td>
</tr>
<tr>
<td>
<a href="https://github.com/surbut/multistate2/blob/e83fb18a5cdd23e13b11f66a5137d2db23ae3368/docs/figure/playing_withtopic.Rmd/unnamed-chunk-5-1.png" target="_blank">e83fb18</a>
</td>
<td>
Sarah Urbut
</td>
<td>
2023-12-26
</td>
</tr>
<tr>
<td>
<a href="https://github.com/surbut/multistate2/blob/b297d53febeb50e785020ae47ba77ed1d0493a9d/docs/figure/playing_withtopic.Rmd/unnamed-chunk-5-1.png" target="_blank">b297d53</a>
</td>
<td>
Sarah Urbut
</td>
<td>
2023-12-25
</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>We can see that this corresponds with the disease we’ve chosen in
topic_disease.</p>
</div>
<div id="visualization-part-2" class="section level1">
<h1>Visualization part 2</h1>
<p>In fact, if we want to visualize all diseases over time, we can
consider the heatmap of <span class="math inline">\(\phi_{k}\)</span>,
and see that only the diseases that are part of the chosen topic
specific disease have a non trivial coloring here.</p>
<p><img src="figure/playing_withtopic.Rmd/unnamed-chunk-6-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-unnamed-chunk-6-1">
Past versions of unnamed-chunk-6-1.png
</button>
</p>
<div id="fig-unnamed-chunk-6-1" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/surbut/multistate2/blob/1c11be69df756c2f08c38eab3a752a7b3f049506/docs/figure/playing_withtopic.Rmd/unnamed-chunk-6-1.png" target="_blank">1c11be6</a>
</td>
<td>
Sarah Urbut
</td>
<td>
2023-12-28
</td>
</tr>
<tr>
<td>
<a href="https://github.com/surbut/multistate2/blob/4d2ac756d3a856171b64cc96406171bce2918d39/docs/figure/playing_withtopic.Rmd/unnamed-chunk-6-1.png" target="_blank">4d2ac75</a>
</td>
<td>
Sarah Urbut
</td>
<td>
2023-12-26
</td>
</tr>
<tr>
<td>
<a href="https://github.com/surbut/multistate2/blob/e83fb18a5cdd23e13b11f66a5137d2db23ae3368/docs/figure/playing_withtopic.Rmd/unnamed-chunk-6-1.png" target="_blank">e83fb18</a>
</td>
<td>
Sarah Urbut
</td>
<td>
2023-12-26
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="however-this-assumes-that-an-individual-stays-within-a-topic"
class="section level2">
<h2>However this assumes that an individual stays within a topic</h2>
<ul>
<li><p>Assumption: that the change in disease distribtuion for a given
topic captures all the heterogeneity of disease coding</p></li>
<li><p>We know that is not the case from our previous work: an
individual can switch to a new pattern based on genetics and
environmental factors, and we should have an ability to ‘update’ an
individuals’ topic distribtuion</p></li>
<li><p>Furthermore, genetics has a <em>declining</em> importance over
time, and the new diagnoses carry more weight. The rate of advancement
<em>through a topic</em> (i.e., the shape of the spline) also may be
affected by these intrinsic factors</p></li>
<li><p>Finally, occupancy in one topic necessarily may prevent other
topics</p></li>
</ul>
</div>
</div>
<div id="example-function-to-update-theta-based-on-new-diagnosis"
class="section level1">
<h1>Example function to update theta based on new diagnosis</h1>
<p>Let’s start by modeling an individual’s transition to a new topic
distribtuion as a funciton of genetics.</p>
<p>That is, <span
class="math inline">\(p(K=k|D)=p(D|K)*p(K)/p(D)\)</span></p>
<p>Here, we will have the genetics influence change by a decay factor,
and the updated theta be proportional to the likelihood of the new
diagnosis:</p>
<p><span
class="math inline">\(\theta_{t+1}=p(D|\theta_{t})*p(\tilde{\theta})\)</span></p>
<p>Here, <span class="math inline">\(p(\tilde{\theta}\)</span>
represents the genetics-adapted prior distribtuion.</p>
<p>Genetics keeps us in the prior distribtuion more at early ages than
later, so the strength of genetics influence on the prior will decline
over time</p>
<pre class="r"><code>update_theta &lt;- function(current_theta, new_diagnosis, phi_time_dependent, genetics_influence, current_time, max_time) {
  # Ensure valid inputs
  if (any(is.na(current_theta)) || any(is.na(phi_time_dependent))) {
    return(current_theta)
  }

  # Decay factor for genetics influence
  decay_factor &lt;- (max_time - current_time) / max_time
  adjusted_genetics_influence &lt;- genetics_influence * decay_factor

  # Select phi for the current time
  phi_current_time &lt;- phi_time_dependent[,,current_time]

  # Check for zero or NA in row sums
  row_sums &lt;- rowSums(phi_current_time)
  if (any(row_sums == 0, is.na(row_sums))) {
    # Handle zero or NA row sums
    row_sums[row_sums == 0 | is.na(row_sums)] &lt;- 1e-10
  }

  # Adjusted prior and likelihood
  adjusted_prior &lt;- current_theta * adjusted_genetics_influence
  
  
  likelihood &lt;- phi_current_time[, new_diagnosis] / row_sums

  # Bayesian update
  updated_theta &lt;- likelihood * adjusted_prior
  total &lt;- sum(updated_theta)
  
  if (total == 0 || is.na(total)) {
    return(current_theta)
  }
  return(updated_theta / total)  # Normalize the updated theta
}</code></pre>
<p>Simulate data:</p>
<pre class="r"><code>M &lt;- 400          # Number of patients
K &lt;- 5            # Number of topics
V &lt;- 300          # Number of diseases
T &lt;- 100          # Number of time steps
max_time &lt;- T     # Assuming T is the maximum time

# Initial topic distributions (theta) for each patient
initial_theta &lt;- rdirichlet(M, shape = rep(0.1, K))

# Time-varying disease distributions within topics (phi)
# Assuming phi is a 3D array (topics x diseases x time)
# This needs to be defined based on your model

# Genetics influence (for simplicity, assuming a constant vector for each patient), how much they want to stay in a topic
genetics_influence &lt;- matrix(runif(M * K, 0.5, 1.5), nrow = M, ncol = K)

# Structure to hold theta values over time for each patient
theta_over_time &lt;- array(dim = c(T, M, K))
theta_over_time[1, , ] &lt;- initial_theta

## check to make sure all 1
all.equal(rowSums(theta_over_time[1,,]),rep(1,nrow(theta_over_time[1,,])))</code></pre>
<pre><code>[1] TRUE</code></pre>
<pre class="r"><code># Function to simulate a new diagnosis (placeholder)
simulate_new_diagnosis &lt;- function() {
  # Randomly simulate a new diagnosis
  return(sample(1:V, 1))
}


for (time in 2:T) {
  for (patient in 1:M) {
    # Simulate a new diagnosis for this patient at this time
    new_diagnosis &lt;- simulate_new_diagnosis()

    # Update the patient&#39;s topic distribution based on the new diagnosis
    theta_over_time[time, patient, ] &lt;- update_theta(
      current_theta = theta_over_time[time - 1, patient, ],
      new_diagnosis = new_diagnosis,
      phi_time_dependent = phi,  # Assuming phi is defined as before
      genetics_influence = genetics_influence[patient, ],
      current_time = time,
      max_time = max_time
    )
  }
}

## should  all be 1
rowSums(theta_over_time[2,,])</code></pre>
<pre><code>  [1] 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
 [38] 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
 [75] 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
[112] 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
[149] 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
[186] 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
[223] 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
[260] 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
[297] 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
[334] 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
[371] 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1</code></pre>
</div>
<div id="topic-distribtuion-per-patient" class="section level1">
<h1>Topic distribtuion per patient</h1>
<p>Now let’s select for a sample patient and view his topic distribution
over time.</p>
<p><img src="figure/playing_withtopic.Rmd/unnamed-chunk-9-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-unnamed-chunk-9-1">
Past versions of unnamed-chunk-9-1.png
</button>
</p>
<div id="fig-unnamed-chunk-9-1" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/surbut/multistate2/blob/1c11be69df756c2f08c38eab3a752a7b3f049506/docs/figure/playing_withtopic.Rmd/unnamed-chunk-9-1.png" target="_blank">1c11be6</a>
</td>
<td>
Sarah Urbut
</td>
<td>
2023-12-28
</td>
</tr>
<tr>
<td>
<a href="https://github.com/surbut/multistate2/blob/4d2ac756d3a856171b64cc96406171bce2918d39/docs/figure/playing_withtopic.Rmd/unnamed-chunk-9-1.png" target="_blank">4d2ac75</a>
</td>
<td>
Sarah Urbut
</td>
<td>
2023-12-26
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="todo-affect-speed-based-through-transitions-based-on-genetics"
class="section level2">
<h2>TODO: affect speed based through transitions based on genetics</h2>
<p>To estimate the speed through a topic for a given polygenic score in
a large-scale simulation, and to predict at what age diseases might
occur for an individual, you can integrate the concept of a polygenic
score into your topic model. This requires a nuanced approach where the
polygenic score influences the rate of progression through a topic. The
idea is similar to genetic penetrance, where certain genetic factors
might lead to earlier or later onset of diseases.</p>
<p>Steps to Integrate Polygenic Score: 1. Incorporate Polygenic Score in
the Model:</p>
<p>Polygenic Score (PGS): Assume each individual has a polygenic score
that quantifies their genetic predisposition towards certain diseases or
disease progressions. Model Adjustment: Adjust the dynamics of your
topic model based on the PGS. Higher scores might imply earlier onset or
faster progression through disease stages within a topic. 2. Modifying
Spline Dynamics Based on PGS:</p>
<p>Dynamic Splines: Use the PGS to alter the parameters of the spline
functions governing the transition through topics. For example,
individuals with a high PGS might have spline functions that shift the
disease probabilities to earlier ages.</p>
<p>Time Scaling: Consider scaling the time axis based on PGS. For
instance, you can modify the time points at which the spline is
evaluated, effectively ‘compressing’ or ‘expanding’ the time scale for
individuals with higher or lower PGS, respectively.</p>
<pre class="r"><code># Function to scale PRS from a normal distribution to a [0, 1] range
scale_prs &lt;- function(prs) {
  # Normalize PRS to be between 0 and 1
  # This is a simple min-max scaling; you can also consider other scaling methods
  scaled_prs &lt;- (prs - min(prs)) / (max(prs) - min(prs))
  return(scaled_prs)
}

# Generate PRS for each individual - normally distributed

N_individuals &lt;- 100  # Number of individuals
prs_raw &lt;- rnorm(N_individuals, mean = 0, sd = 1)
prs_values &lt;- scale_prs(prs_raw)

# Simulate PGS values for individuals

# Create an array to store individual-specific phi values, initialize with same for all 
phi_base &lt;- matrix(nrow = K, ncol = V)

for (k in 1:K) {
    beta &lt;- rep(1/V, V)  # Start with low probabilities

    # Set higher probabilities for topic-specific diseases
    for (v in topic_spec_disease[k,]) {
        beta[v] &lt;- (V-d)/V
    }
    
    # Initialize baseline phi for topic k using a Dirichlet distribution
    phi_base[k, ] &lt;- rdirichlet(1, beta)
}

## check to make sure mostly topic hits
which(order(phi_base[1,],decreasing = T)%in%topic_spec_disease[1,])</code></pre>
<pre><code> [1]  1  2  3  4  5  6  7  8  9 10</code></pre>
<pre class="r"><code># Expand phi_base to create the initial phi array for all individuals
phi &lt;- array(dim = c(length(prs_values), V, K, length(time_points)))
for (i in 1:length(prs_values)) {
    phi[i, , , 1] &lt;- t(phi_base)  # Set the baseline phi for each individual
}

## check to make sure mostly topic hits
which(order(phi[i,,1,1],decreasing = T)%in%topic_spec_disease[1,])</code></pre>
<pre><code> [1]  1  2  3  4  5  6  7  8  9 10</code></pre>
<pre class="r"><code>which(order(phi[i,,2,1],decreasing = T)%in%topic_spec_disease[2,])</code></pre>
<pre><code> [1]  1  2  3  4  5  6  7  8 10 11</code></pre>
<pre class="r"><code>summary(rowSums(phi[,,,1]))</code></pre>
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
      5       5       5       5       5       5 </code></pre>
<pre class="r"><code>all_normalized &lt;- all(apply(phi[,, , 1], c(1,3), function(x) abs(sum(x) - 1) &lt; .Machine$double.eps^0.5))
print(all_normalized)  # Sh</code></pre>
<pre><code>[1] TRUE</code></pre>
<pre class="r"><code># Functions to calculate the effects of PRS on the spline coefficients and time scale
# can&#39;t change coefficient if constained to proper probability distirbution


time_scale_adjustment &lt;- function(prs) {
  # Define the relationship between PRS and time scale
  # This is a placeholder; you need to define how PRS affects time scale
  return(1 - prs)  # PRS compresses time scale
}


# Apply time scale adjustment based on PRS
for (k in 1:K) {
  for (v in 1:V) {
    # Use base coefficients for the spline, should be same for every person, only the time scale changes
    base_coef &lt;- runif(length(knots) + degree + 1, min = 0, max = 5)
    for (i in 1:length(prs_values)) {
      # Adjust time points based on individual&#39;s PRS
      prs_time &lt;- time_scale_adjustment(prs_values[i])
      adjusted_time_points &lt;- time_points[-1] * prs_time
      # Re-calculate the spline basis for the adjusted time points
      adjusted_bspline_basis &lt;-
        bs(
          adjusted_time_points,
          knots = knots,
          degree = degree,
          intercept = TRUE
        )
      # Calculate spline values with base coefficients
      spline_values &lt;- adjusted_bspline_basis %*% base_coef
      # Store the values in phi, normalized across diseases at each time point
      phi[i, v , k ,-1] &lt;- spline_values * phi[i, v, k, 1]
      # Normalize the values across diseases
    }
  }
}

high=order(prs_values,decreasing = TRUE)[3]
low=order(prs_values,decreasing = FALSE)[3]


## check to make sure same at time 1
sapply(seq(1:K),function(k){all.equal(phi[high,,k,1],phi[low,,k,1])})</code></pre>
<pre><code>[1] TRUE TRUE TRUE TRUE TRUE</code></pre>
<pre class="r"><code>## normalize to a proper distribution
for(i in 1:length(prs_values)){
for(k in 1:K){
  for(t in 1:T){
    phi[i,,k,t]/sum(phi[i,,k,t])
  }}}



## check to make sure still same at time 1
sapply(seq(1:K),function(k){all.equal(phi[high,,k,1],phi[low,,k,1])})</code></pre>
<pre><code>[1] TRUE TRUE TRUE TRUE TRUE</code></pre>
<pre class="r"><code>all_normalized &lt;- all(apply(phi[,, , 1], c(1,3), function(x) abs(sum(x) - 1) &lt; .Machine$double.eps^0.5))
print(all_normalized)  </code></pre>
<pre><code>[1] TRUE</code></pre>
<p>So now we can visualize someone with a high risk and low risk PRS
loaded on same topic:</p>
<pre class="r"><code>high=order(prs_values,decreasing = TRUE)[3]
low=order(prs_values,decreasing = FALSE)[3]

## check to make sure initailization same
sapply(seq(1:K),function(k){all.equal(phi[high,,k,1],phi[low,,k,1])})</code></pre>
<pre><code>[1] TRUE TRUE TRUE TRUE TRUE</code></pre>
<pre class="r"><code>par(mfrow=c(1,2))
matplot(t(phi[high,topic_spec_disease[1,],1,]))
matplot(t(phi[low,topic_spec_disease[1,],1,]))</code></pre>
<p><img src="figure/playing_withtopic.Rmd/unnamed-chunk-10-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-unnamed-chunk-10-1">
Past versions of unnamed-chunk-10-1.png
</button>
</p>
<div id="fig-unnamed-chunk-10-1" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/surbut/multistate2/blob/1c11be69df756c2f08c38eab3a752a7b3f049506/docs/figure/playing_withtopic.Rmd/unnamed-chunk-10-1.png" target="_blank">1c11be6</a>
</td>
<td>
Sarah Urbut
</td>
<td>
2023-12-28
</td>
</tr>
<tr>
<td>
<a href="https://github.com/surbut/multistate2/blob/4d2ac756d3a856171b64cc96406171bce2918d39/docs/figure/playing_withtopic.Rmd/unnamed-chunk-10-1.png" target="_blank">4d2ac75</a>
</td>
<td>
Sarah Urbut
</td>
<td>
2023-12-26
</td>
</tr>
</tbody>
</table>
</div>
</div>
<br>
<p>
<button type="button" class="btn btn-default btn-workflowr btn-workflowr-sessioninfo" data-toggle="collapse" data-target="#workflowr-sessioninfo" style="display: block;">
<span class="glyphicon glyphicon-wrench" aria-hidden="true"></span>
Session information
</button>
</p>
<div id="workflowr-sessioninfo" class="collapse">
<pre class="r"><code>sessionInfo()</code></pre>
<pre><code>R version 4.3.1 (2023-06-16)
Platform: aarch64-apple-darwin20 (64-bit)
Running under: macOS Sonoma 14.0

Matrix products: default
BLAS:   /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRblas.0.dylib 
LAPACK: /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.11.0

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

time zone: America/Chicago
tzcode source: internal

attached base packages:
[1] splines   stats     graphics  grDevices utils     datasets  methods  
[8] base     

other attached packages:
[1] reshape2_1.4.4 ggplot2_3.4.4  rBeta2009_1.0 

loaded via a namespace (and not attached):
 [1] gtable_0.3.4      jsonlite_1.8.7    highr_0.10        dplyr_1.1.4      
 [5] compiler_4.3.1    promises_1.2.1    tidyselect_1.2.0  Rcpp_1.0.11      
 [9] stringr_1.5.1     git2r_0.32.0      later_1.3.1       jquerylib_0.1.4  
[13] scales_1.2.1      yaml_2.3.7        fastmap_1.1.1     plyr_1.8.9       
[17] R6_2.5.1          labeling_0.4.3    generics_0.1.3    workflowr_1.7.1  
[21] knitr_1.45        tibble_3.2.1      munsell_0.5.0     rprojroot_2.0.4  
[25] bslib_0.6.0       pillar_1.9.0      rlang_1.1.2       utf8_1.2.4       
[29] cachem_1.0.8      stringi_1.8.2     httpuv_1.6.12     xfun_0.41        
[33] fs_1.6.3          sass_0.4.7        cli_3.6.1         withr_2.5.2      
[37] magrittr_2.0.3    digest_0.6.33     grid_4.3.1        rstudioapi_0.15.0
[41] lifecycle_1.0.4   vctrs_0.6.4       evaluate_0.23     glue_1.6.2       
[45] farver_2.1.1      whisker_0.4.1     colorspace_2.1-0  fansi_1.0.5      
[49] rmarkdown_2.25    tools_4.3.1       pkgconfig_2.0.3   htmltools_0.5.7  </code></pre>
</div>
</div>
</div>


<!-- Adjust MathJax settings so that all math formulae are shown using
TeX fonts only; see
https://docs.mathjax.org/en/latest/web/configuration.html. This will make
the presentation more consistent at the cost of the webpage sometimes
taking slightly longer to load. Note that this only works because the
footer is added to webpages before the MathJax javascript. -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    "HTML-CSS": { availableFonts: ["TeX"] }
  });
</script>




</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->

<script>
$(document).ready(function ()  {

    // temporarily add toc-ignore selector to headers for the consistency with Pandoc
    $('.unlisted.unnumbered').addClass('toc-ignore')

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
