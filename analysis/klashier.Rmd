---
title: "Flashier"
output: html_document
date: "2023-11-26"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Let's do some flashing!

```{r cars}
library(flashier)
library(data.table)
filepath="~/Library/CloudStorage/Dropbox-Personal/pheno_dir/"

df.phecode.wide=readRDS("~/Library/CloudStorage/Dropbox-Personal/phecode/df.phecode.wide.rds")
#df.phecode.wide[is.na(df.phecode.wide)]=0

dfw=df.phecode.wide[,-c(1:5)]

## First create a sparse matrix of loadings on the non-9 ages

dfw[!is.na(dfw)]=1
dfw[is.na(dfw)]=0

X=as.matrix(dfw)
#install.packages("flashier")
## remove individuals never phenotyped

X=X[which(rowSums(X)>0),]

X=X[,which(colSums(X)>500)]
K=12
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE,eval=F}
fit_default <- flash(as.matrix(scale(X)), greedy_Kmax = 20)
plot(fit_default, pw_which = "factors")
saveRDS(fit_default,file=paste0(filepath,"fit_default_all.rds"))
```

```{r}
fit=readRDS(paste0(filepath,"fit_default_all.rds"))

dim(fit$F_pm)[1]
plot(fit, pw_which = "factors")
```


## now let's only look at disease that occur before 50

```{r lessthan50,eval=F}
K=12
dfw=df.phecode.wide[,-c(1:5)]

## First create a sparse matrix of loadings on the non-NA ages
# Assuming your data.table is named your_data_table
age_threshold <- 50  # Replace with your desired age threshold

# Apply the operation to all columns
dfw[, (1:ncol(dfw)) := lapply(.SD, function(x) ifelse(!is.na(x) & x < age_threshold, 1, 0))]


X=as.matrix(dfw)
#install.packages("flashier")
## remove individuals never phenotyped
X=X[which(rowSums(X)>0),]
X=X[,which(colSums(X)>500)]


print(dim(X))

fit_default50 <- flash(as.matrix(scale(X)), greedy_Kmax = K)
plot(fit_default50, pw_which = "factors")
saveRDS(fit_default50,file=paste0(filepath,"fit_default50.rds"))
```

```{r}
fit=readRDS(paste0(filepath,"fit_default50.rds"))
dim(fit$F_pm)[1]
plot(fit, pw_which = "factors")
```

## 50-60

```{r between50.60,eval=F}

dfw=df.phecode.wide[,-c(1:5)]

## First create a sparse matrix of loadings on the non-NA ages

## First create a sparse matrix of loadings on the non-NA ages
# Assuming your data.table is named your_data_table
age_threshold <- 60  # Replace with your desired age threshold

# Apply the operation to all columns
dfw[, (1:ncol(dfw)) := lapply(.SD, function(x) ifelse(!is.na(x) & x < age_threshold & x > (age_threshold-10), 1, 0))]




X=as.matrix(dfw)
#install.packages("flashier")
## remove individuals never phenotyped

X=X[which(rowSums(X)>0),]
X=X[,which(colSums(X)>500)]
print(dim(X))

fit_default60 <- flash(as.matrix(scale(X)), greedy_Kmax = K)
plot(fit_default60, pw_which = "factors")
saveRDS(fit_default60,file=paste0(filepath,"fit_default60.rds"))
```

```{r}
fit=readRDS(paste0(filepath,"fit_default60.rds"))
dim(fit$F_pm)[1]
plot(fit, pw_which = "factors")
```


```{r betw6070,eval=F}
dfw=df.phecode.wide[,-c(1:5)]
## First create a sparse matrix of loadings on the non-NA ages
## First create a sparse matrix of loadings on the non-NA ages
# Assuming your data.table is named your_data_table
age_threshold <- 70  # Replace with your desired age threshold

# Apply the operation to all columns
dfw[, (1:ncol(dfw)) := lapply(.SD, function(x) ifelse(!is.na(x) & x < age_threshold & x > (age_threshold-10), 1, 0))]

X=as.matrix(dfw)
#install.packages("flashier")
## remove individuals never phenotyped
X=X[which(rowSums(X)>0),]
X=X[,which(colSums(X)>500)]

print(dim(X))

fit_default70 <- flash(as.matrix(scale(X)), greedy_Kmax = K)
plot(fit_default70, pw_which = "factors")
saveRDS(fit_default70,file=paste0(filepath,"fit_default70.rds"))
```


```{r}
fit=readRDS(paste0(filepath,"fit_default70.rds"))
dim(fit$F_pm)[1]
plot(fit, pw_which = "factors")
```

```{r greater70,eval=F}
dfw=df.phecode.wide[,-c(1:5)]
## First create a sparse matrix of loadings on the non-NA ages

## First create a sparse matrix of loadings on the non-NA ages
# Assuming your data.table is named your_data_table
age_threshold <- 70  # Replace with your desired age threshold

# Apply the operation to all columns
dfw[, (1:ncol(dfw)) := lapply(.SD, function(x) ifelse(!is.na(x) & x > (age_threshold), 1, 0))]

X=as.matrix(dfw)
#install.packages("flashier")
## remove individuals never phenotyped
X=X[which(rowSums(X)>0),]
X=X[,which(colSums(X)>500)]

print(dim(X))
fit_defaultold <- flash(as.matrix(scale(X)), greedy_Kmax = K)
saveRDS(fit_defaultold,file=paste0(filepath,"fit_defaultold.rds"))
```


```{r}
fit=readRDS(paste0(filepath,"fit_defaultold.rds"))
dim(fit$F_pm)[1]
plot(fit, pw_which = "factors")
```

## Let's examine to see if the factors are similar among ages

```{r}
overall=readRDS(paste0(filepath,"fit_default_all.rds"))
head(sort(overall$F_pm[,1],decreasing = T),10)
head(sort(overall$F_pm[,2],decreasing = T),10)

fit50=readRDS(paste0(filepath,"fit_default50.rds"))
head(sort(fit50$F_pm[,1],decreasing = T),10)
head(sort(fit50$F_pm[,2],decreasing = T),10)

fit60=readRDS(paste0(filepath,"fit_default60.rds"))
head(sort(fit60$F_pm[,1],decreasing = T),10)
head(sort(fit60$F_pm[,2],decreasing = T),10)

fit70=readRDS(paste0(filepath,"fit_default70.rds"))
head(sort(fit70$F_pm[,1],decreasing = T),10)
head(sort(fit70$F_pm[,2],decreasing = T),10)

fitold=readRDS(paste0(filepath,"fit_defaultold.rds"))
head(sort(fitold$F_pm[,1],decreasing = T),10)
head(sort(fitold$F_pm[,2],decreasing = T),10)
```

