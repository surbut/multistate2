---
title: "Figure4"
output: html_document
date: "2023-11-13"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,warning = FALSE,message=FALSE)
```

## Plot age exceeded for each score using your choice of lifetime (here 10) or ten year (here 5) threshold

```{r cars}
library("ggsci")
library(dplyr)
library(tidyr)
library(data.table)
library(ggplot2)
library(ggpubr)

test=readRDS("~/multistate2/output/test.rds")
pce.reverse.tenyear=readRDS("~/multistate2/output/pce.reverse.tenyear.rds")
ascvd.30.year=readRDS("~/multistate2/output/ascvd.30year.rds")
#ascvd.30.year.rc=readRDS("~/multistate2/output/ascvd.30year.rc.rds")
ascvd.30.year.rc=readRDS("~/multistate2/output/ascvd.30year.rcnew.rds")

      
#head(pce.reverse.tenyear)
agesint=c(40:80)
thresh=5;
ten=apply(pce.reverse.tenyear,1,function(x){min(agesint[x>thresh])})
thresh=10;
thirty=apply(ascvd.30.year.rc,1,function(x){
  w=which(x>thresh)
  ifelse(length(w)>0,min(agesint[w]),100)})


### this is the data frame with approportiate score
states=readRDS("~/multistate2/output/state_occupancy_risk.rds")
ages=c(40:80)
thresh=0.10;
t=sapply(1:length(states),function(x){w=which(states[[x]]>thresh);ifelse(length(w)>0,min(ages[w]),100)})

df=data.frame("id"=test$identifier,"Cad_0_Any"=test$Cad_0_Any,"Cad_0_censor_age"=test$Cad_0_censor_age,"sex"=test$f.31.0.0,"prs"=test$cad.prs,"ten"=ten,"thirty"=thirty,"ms"=t,"enroll"=test$phenos.enrollment)

data <- data.frame(t_val = t)
# Create the ggplot histogram
p <- ggplot(data, aes(x = t_val)) +
geom_histogram(bins = length(ages) - 1, fill = "red3", color = "black", alpha = 0.7, aes(y =after_stat(density))) +
labs(title = "Histogram of Age Exceeding Risk: MSGene Lifetime",
x = "Age Exceeded",
y = "Density")+theme_classic()+lims(y=c(0,0.30))


data <- data.frame(t_val = ten)
# Create the ggplot histogram
p2 <- ggplot(data, aes(x = t_val)) +
geom_histogram(bins = length(ages) - 1, fill = "darkblue", color = "black", alpha = 0.7, aes(y =after_stat(density))) +
labs(title = "Histogram of Age Exceeding Risk: Ten-year (Pooled Cohort Equation)",
x = "Age Exceeded",y = "Density")+theme_classic()+xlim(39,80)+lims(y=c(0,0.30))

data <- data.frame(t_val = thirty)
# Create the ggplot histogram
p3 <- ggplot(data, aes(x = t_val)) +
geom_histogram(bins = length(ages) - 1, fill = "darkgreen", color = "black", alpha = 0.7, aes(y =after_stat(density))) +
labs(title = "Histogram of Age Exceeding Risk: 30-year (Framingham recalibrated)",
x = "Age Exceeded",y = "Density")+theme_classic()

 gathresh=ggarrange(p,p2,p3,nrow = 3)
gathresh
```

## Including Plots

You can also embed plots, for example:

```{r , echo=FALSE}
df_expanded <- data.frame(
  id = integer(), 
  start = numeric(), 
  stop = numeric(), 
  event = integer(), 
  score1 = integer(), 
  score2 = integer(),
  score3 = integer()
)

library(data.table)

# Convert df to data.table
# Convert df to data.table
setDT(df)

expand_data <- function(id, cad_status, censor_age, score1_age, score2_age,score3_age,enroll) {
  ages <- sort(c(enroll, score1_age, score2_age,score3_age, censor_age))
  result <- list()
  
  for(j in 1:(length(ages) - 1)) {
    start_age <- ages[j]
    stop_age <- ages[j+1]
    
    if(start_age == stop_age) next # skip if they are the same
    
    s1 <- ifelse(start_age >= score1_age, 1, 0)
    s2 <- ifelse(start_age >= score2_age, 1, 0)
    s3 <- ifelse(start_age >= score3_age, 1, 0)
    
    event_at_stop <- ifelse(stop_age == censor_age && cad_status == 2, 1, 0)
    
    result[[length(result) + 1]] <- list(id = id, start = start_age, stop = stop_age, event = event_at_stop, score1 = s1, score2 = s2, score3=s3,enroll=enroll)
  }
  
  return(result)
}

list_dt <- lapply(1:nrow(df), function(i) {
  row <- df[i,]
  expand_data(row$id, row$Cad_0_Any, row$Cad_0_censor_age, row$thirty, row$ms,row$ten,row$enroll)
})



# score1 is FRS30y
# score2 MSGene
# score3 TenY

df_expanded <- rbindlist(unlist(list_dt, recursive = FALSE))

## left censor for calculation
df_expanded=df_expanded[df_expanded$start>=df_expanded$enroll,]

library(survival)

# Bootstrap function for C-index
bootstrap_cindex <- function(fit_function, data, n_iter=10) {
  cindices <- numeric(n_iter)
  
  for(i in 1:n_iter) {
    sample_rows <- sample(1:nrow(data), replace = TRUE)
    sample_data <- data[sample_rows, ]
    
    fit <- fit_function(sample_data)
    cindices[i] <- summary(fit)$concordance[1]
  }
  
  return(list(mean = mean(cindices), se = sd(cindices)))
}

# Fit functions for score1 and score2
fit_function_score1 <- function(data) coxph(Surv(start, stop, event) ~ score1, data=data)
fit_function_score2 <- function(data) coxph(Surv(start, stop, event) ~ score2, data = data)
fit_function_score3 <- function(data) coxph(Surv(start, stop, event) ~ score3, data = data) #[data$stop<(data$start+10),])



# Bootstrap C-index

results_score1 <- bootstrap_cindex(fit_function_score1, df_expanded)
results_score2 <- bootstrap_cindex(fit_function_score2, df_expanded)
results_score3 <- bootstrap_cindex(fit_function_score3, df_expanded)


# Confidence intervals (95%)
ci_score1 <- c(results_score1$mean - 1.96*results_score1$se, results_score1$mean + 1.96*results_score1$se)
ci_score2 <- c(results_score2$mean - 1.96*results_score2$se, results_score2$mean + 1.96*results_score2$se)
ci_score3 <- c(results_score3$mean - 1.96*results_score3$se, results_score3$mean + 1.96*results_score2$se)

# Plot using ggplot2
library(ggplot2)

df_cindex <- data.frame(
  Score = c("PCE 10 year","30 Year","MSGene"),
  Cindex = c(results_score3$mean,results_score1$mean,results_score2$mean),
  ymin = c(ci_score3[1], ci_score1[1],ci_score2[1]),
  ymax = c(ci_score3[1], ci_score1[2],ci_score2[2])
  
)



df_cindex
#         Score    Cindex      ymin      ymax
# 1 PCE 10 year 0.5499947 0.5472029 0.5472029
# 2     30 Year 0.5178130 0.5169781 0.5186479
# 3      MSGene 0.7244679 0.7182022 0.7307336

# df_cindex using full  window
# Score    Cindex      ymin      ymax
#1 PCE 10 year 0.5793123 0.5755219 0.5755219
#2     30 Year 0.5304823 0.5282367 0.5327279
#3      MSGene 0.6994852 0.6958186 0.7031518
     
## for 2 v 3 2*(pnorm(28.33,lower.tail = F))
     
#deltac=(results_score2$mean-results_score1$mean)/(sqrt(results_score2$se^2+results_score1$se^2))
#2*pnorm(deltac,lower.tail = F)
     
df_cindex$Score <- factor(df_cindex$Score, levels = c("PCE 10 year", "30 Year", "MSGene"))
cp <- ggplot(df_cindex, aes(x = Score, y = Cindex,fill=Score)) +
  geom_bar(stat = "identity", position = position_dodge()) +
  geom_errorbar(aes(ymin=ymin, ymax=ymax), width=0.1, position=position_dodge(0.9)) +
  ylim(0,0.8 ) +
  labs(
    title = "Comparison of Predictive Performance",
    subtitle = "Using Bootstrap 95% CI for C-index (Concordance Index)",
    y = "C-index Value",
    x = ""
  ) +
  theme_classic()+scale_fill_manual(values = c("darkblue","darkgreen","red3"))


cp
```


Now do for continous variable: 

```{r}

test=readRDS("~/multistate2/output/test.rds")
pce.reverse.tenyear=readRDS("~/multistate2/output/pce.reverse.tenyear.rds")
ascvd.30.year.rc=readRDS("~/multistate2/output/ascvd.30year.rcnew.rds")
states=readRDS("~/multistate2/output/state_occupancy_risk.rds")

# Fit functions for score1 and score2
fit_function_score1 <- function(data) coxph(Surv(start, stop, event) ~ score1, data = data)
fit_function_score2 <- function(data) coxph(Surv(start, stop, event) ~ score2, data)
#[data$stop<=(data$start+30),])
fit_function_score3 <- function(data) coxph(Surv(start, stop, event) ~ score3, data = data)

df=test
df$Cad_0_censor_age=round(df$Cad_0_censor_age,0)
df$Cad_0_Any=ifelse(df$Cad_0_Any==2,1,0)
bad_indices=which(df$Cad_0_censor_age>=80&df$Cad_0_Any==1)


expanded_df <- data.frame()

score1_list=states
names(score1_list)=df$identifier
score2=ascvd.30.year.rc
rownames(score2)=df$identifier

score3=pce.reverse.tenyear
rownames(score3)=df$identifier

# Removing the bad IDs from score1_list
score1_list <- score1_list[-bad_indices]

# Removing the bad IDs from score2 dataframe
score2 <- score2[-bad_indices, ]

# Removing the bad IDs from score2 dataframe
score3 <- score3[-bad_indices, ]

df=df[-which(df$Cad_0_censor_age>=80&df$Cad_0_Any==1),]
dim(df)


all.equal(as.numeric(names(score1_list)),as.numeric(df$identifier))

all.equal(as.numeric(rownames(score2)),as.numeric(df$identifier))

all.equal(as.numeric(rownames(score3)),as.numeric(df$identifier))
# Initialize a list to store the results
expanded_list <- vector("list", length = nrow(df))

for(i in 1:nrow(df)) {
  #print(i)
  id <- df$id[i]
  max_age <- df$Cad_0_censor_age[i]
  event <- df$Cad_0_Any[i]
   enroll = df$phenos.enrollment[i]
  
  # When max_age is less than 40 or length of score1_list[i] is 0
  if (max_age < 40 || length(score1_list[[i]]) == 0) {
    next  # Skip this iteration and proceed to the next
  }
  
  age_range <- 40:(40 + length(score1_list[[i]]) - 1)
  score1_values <- score1_list[[i]]
  score2_values <- score2[i, age_range - 39]
  score3_values <- score3[i, age_range - 39]
  
  # If there's an event and score1 is shorter than expected
  if (event == 1 && max(age_range) < max_age) {
    extended_age_range <- (max(age_range) + 1):max_age  
    score1_last_value <- rep(tail(score1_list[[i]], 1), times = length(extended_age_range))
    score1_values <- c(score1_list[[i]], score1_last_value)
    score2_last_value <- score2[i,(extended_age_range-39)]
    score2_values <- c(score2_values, score2_last_value)
    score3_last_value <- score3[i,(extended_age_range-39)]
    score3_values <- c(score3_values, score3_last_value)
    age_range <- c(age_range, extended_age_range)
  }
  
  # Store the resulting dataframe as a list element
  expanded_list[[i]] <- data.frame(id = id,
                                   age = age_range,
                                   score1 = score1_values,
                                   score2 = score2_values,
                                   score3 = score3_values,
                                   enroll=enroll,
                                   event = ifelse(age_range == max_age, event, 0))
}

# Combine all the dataframes in the list at once
expanded_df <- do.call(rbind, expanded_list)
expanded_df$score1=expanded_df$score1*100
expanded_df$start <- expanded_df$age
expanded_df$stop <- expanded_df$age + 1


print(dim(expanded_df))

expanded_df=expanded_df[expanded_df$start>=expanded_df$enroll,]


# Bootstrap C-index
results_score1 <- bootstrap_cindex(fit_function_score1, expanded_df)
results_score2 <- bootstrap_cindex(fit_function_score2, expanded_df)
results_score3 <- bootstrap_cindex(fit_function_score3, expanded_df)


# difference between States and FRS30
# deltac=(results_score1$mean-results_score2$mean)/(sqrt(results_score1$se^2+results_score2$se^2))
# 2*pnorm(deltac,lower.tail = F)
# 
# # difference between States and PCE
# deltac=(results_score1$mean-results_score3$mean)/(sqrt(results_score3$se^2+results_score1$se^2))
# 2*pnorm(deltac,lower.tail = F)
# Confidence intervals (95%)
ci_score1 <- c(results_score1$mean - 1.96*results_score1$se, results_score1$mean + 1.96*results_score1$se)
ci_score2 <- c(results_score2$mean - 1.96*results_score2$se, results_score2$mean + 1.96*results_score2$se)
ci_score3 <- c(results_score3$mean - 1.96*results_score3$se, results_score3$mean + 1.96*results_score3$se)

# Plot using ggplot2
library(ggplot2)

(df_cindex <- data.frame(
  Score = c( "MSGene","30 Year","Ten Year"),
  Cindex = c(results_score1$mean, results_score2$mean,results_score3$mean),
  ymin = c(ci_score1[1], ci_score2[1],ci_score3[1]),
  ymax = c(ci_score1[2], ci_score2[2],ci_score3[2])
))


#      Score    Cindex      ymin      ymax
# 1   MSGene 0.7087781 0.7030549 0.7145013
# 2  30 Year 0.6641906 0.6613608 0.6670204
# 3 Ten Year 0.6686567 0.6626779 0.6746356

#      Score    Cindex      ymin      ymax
# 1   MSGene 0.7381202 0.7309171 0.7453232
# 2  30 Year 0.6549914 0.6494579 0.6605249
# 3 Ten Year 0.6684417 0.6637123 0.6731711

p <- ggplot(df_cindex, aes(x = Score, y = Cindex,fill=Score)) +
  geom_bar(stat = "identity", position = position_dodge()) +
  geom_errorbar(aes(ymin=ymin, ymax=ymax), width=0.1, position=position_dodge(0.9)) +
  ylim(0,0.8 ) +
  labs(
    title = "Comparison of Predictive Performance",
    subtitle = "Using Bootstrap 95% CI for C-index (Concordance Index)",
    y = "C-index Value",
    x = ""
  ) +
  theme_classic()+scale_fill_aaas()

print(p)


```

## Analaysis with Ethnitiy

```{r}
rm(list=ls())
gae=fread("~/Library/CloudStorage/Dropbox-Personal/ukb.kgp_projected.tsv.gz")
pop="AFR"
print(pop)

popid=gae$eid[gae$rf80%in%pop]
test=readRDS("~/multistate2/output/test.rds")
states=readRDS("~/multistate2/output/state_occupancy_risk.rds")
names(states)=test$identifier
pce.reverse.tenyear=readRDS("~/multistate2/output/pce.reverse.tenyear.rds")
ascvd.30.year=readRDS("~/multistate2/output/ascvd.30year.rds")
ascvd.30.year.rc=readRDS("~/multistate2/output/ascvd.30year.rcnew.rds")

rownames(ascvd.30.year.rc)=rownames(ascvd.30.year)=rownames(pce.reverse.tenyear)=test$identifier

test=test[test$identifier%in%popid,]
states=states[names(states)%in%popid]

pce.reverse.tenyear=pce.reverse.tenyear[rownames(pce.reverse.tenyear)%in%popid,]
ascvd.30.year=ascvd.30.year[rownames(ascvd.30.year)%in%popid,]
ascvd.30.year.rc=ascvd.30.year.rc[rownames(ascvd.30.year.rc)%in%popid,]




#head(pce.reverse.tenyear)
agesint=c(40:80)
thresh=5;
ten=apply(pce.reverse.tenyear,1,function(x){min(agesint[x>thresh])})
thresh=10;
thirty=apply(ascvd.30.year.rc,1,function(x){
  w=which(x>thresh)
  ifelse(length(w)>0,min(agesint[w]),100)})


### this is the data frame with approportiate score

ages=c(40:80)
thresh=0.10;
t=sapply(1:length(states),function(x){w=which(states[[x]]>thresh);ifelse(length(w)>0,min(ages[w]),100)})

df=data.frame("id"=test$identifier,"Cad_0_Any"=test$Cad_0_Any,"Cad_0_censor_age"=test$Cad_0_censor_age,"sex"=test$f.31.0.0,"prs"=test$cad.prs,"ten"=ten,"thirty"=thirty,"ms"=t,"enroll"=test$phenos.enrollment)

data <- data.frame(t_val = t)
# Create the ggplot histogram
p <- ggplot(data, aes(x = t_val)) +
geom_histogram(bins = length(ages) - 1, fill = "red3", color = "black", alpha = 0.7, aes(y =after_stat(density))) +
labs(title = "Histogram of Age Exceeding Risk: MSGene Lifetime",
x = "Age Exceeded",
y = "Density")+theme_classic()+lims(y=c(0,0.30))


data <- data.frame(t_val = ten)
# Create the ggplot histogram
p2 <- ggplot(data, aes(x = t_val)) +
geom_histogram(bins = length(ages) - 1, fill = "darkblue", color = "black", alpha = 0.7, aes(y =after_stat(density))) +
labs(title = "Histogram of Age Exceeding Risk: Ten-year (Pooled Cohort Equation)",
x = "Age Exceeded",y = "Density")+theme_classic()+xlim(39,80)+lims(y=c(0,0.30))

data <- data.frame(t_val = thirty)
# Create the ggplot histogram
p3 <- ggplot(data, aes(x = t_val)) +
geom_histogram(bins = length(ages) - 1, fill = "darkgreen", color = "black", alpha = 0.7, aes(y =after_stat(density))) +
labs(title = "Histogram of Age Exceeding Risk: 30-year (Framingham recalibrated)",
x = "Age Exceeded",y = "Density")+theme_classic()

 gathresh=ggarrange(p,p2,p3,nrow = 3)
gathresh
```

## Including Plots

You can also embed plots, for example:

```{r , echo=FALSE}
df_expanded <- data.frame(
  id = integer(), 
  start = numeric(), 
  stop = numeric(), 
  event = integer(), 
  score1 = integer(), 
  score2 = integer(),
  score3 = integer()
)

library(data.table)

# Convert df to data.table
# Convert df to data.table
setDT(df)

expand_data <- function(id, cad_status, censor_age, score1_age, score2_age,score3_age,enroll) {
  ages <- sort(c(enroll, score1_age, score2_age,score3_age, censor_age))
  result <- list()
  
  for(j in 1:(length(ages) - 1)) {
    start_age <- ages[j]
    stop_age <- ages[j+1]
    
    if(start_age == stop_age) next # skip if they are the same
    
    s1 <- ifelse(start_age >= score1_age, 1, 0)
    s2 <- ifelse(start_age >= score2_age, 1, 0)
    s3 <- ifelse(start_age >= score3_age, 1, 0)
    
    event_at_stop <- ifelse(stop_age == censor_age && cad_status == 2, 1, 0)
    
    result[[length(result) + 1]] <- list(id = id, start = start_age, stop = stop_age, event = event_at_stop, score1 = s1, score2 = s2, score3=s3,enroll=enroll)
  }
  
  return(result)
}

list_dt <- lapply(1:nrow(df), function(i) {
  row <- df[i,]
  expand_data(row$id, row$Cad_0_Any, row$Cad_0_censor_age, row$thirty, row$ms,row$ten,row$enroll)
})



# score1 is FRS30y
# score2 MSGene
# score3 TenY

df_expanded <- rbindlist(unlist(list_dt, recursive = FALSE))

## left censor for calculation
df_expanded=df_expanded[df_expanded$start>=df_expanded$enroll,]

library(survival)

# Bootstrap function for C-index
bootstrap_cindex <- function(fit_function, data, n_iter=10) {
  cindices <- numeric(n_iter)
  
  for(i in 1:n_iter) {
    sample_rows <- sample(1:nrow(data), replace = TRUE)
    sample_data <- data[sample_rows, ]
    
    fit <- fit_function(sample_data)
    cindices[i] <- summary(fit)$concordance[1]
  }
  
  return(list(mean = mean(cindices), se = sd(cindices)))
}

# Fit functions for score1 and score2
fit_function_score1 <- function(data) coxph(Surv(start, stop, event) ~ score1, data=data)
fit_function_score2 <- function(data) coxph(Surv(start, stop, event) ~ score2, data = data)
fit_function_score3 <- function(data) coxph(Surv(start, stop, event) ~ score3, data = data) #[data$stop<(data$start+10),])



# Bootstrap C-index

results_score1 <- bootstrap_cindex(fit_function_score1, df_expanded)
results_score2 <- bootstrap_cindex(fit_function_score2, df_expanded)
results_score3 <- bootstrap_cindex(fit_function_score3, df_expanded)


# Confidence intervals (95%)
ci_score1 <- c(results_score1$mean - 1.96*results_score1$se, results_score1$mean + 1.96*results_score1$se)
ci_score2 <- c(results_score2$mean - 1.96*results_score2$se, results_score2$mean + 1.96*results_score2$se)
ci_score3 <- c(results_score3$mean - 1.96*results_score3$se, results_score3$mean + 1.96*results_score2$se)

# Plot using ggplot2
library(ggplot2)

df_cindex <- data.frame(
  Score = c("PCE 10 year","30 Year","MSGene"),
  Cindex = c(results_score3$mean,results_score1$mean,results_score2$mean),
  ymin = c(ci_score3[1], ci_score1[1],ci_score2[1]),
  ymax = c(ci_score3[1], ci_score1[2],ci_score2[2])
  
)



df_cindex
#         Score    Cindex      ymin      ymax
# 1 PCE 10 year 0.5499947 0.5472029 0.5472029
# 2     30 Year 0.5178130 0.5169781 0.5186479
# 3      MSGene 0.7244679 0.7182022 0.7307336

# df_cindex using full  window
# Score    Cindex      ymin      ymax
#1 PCE 10 year 0.5793123 0.5755219 0.5755219
#2     30 Year 0.5304823 0.5282367 0.5327279
#3      MSGene 0.6994852 0.6958186 0.7031518
     
## for 2 v 3 2*(pnorm(28.33,lower.tail = F))
     
#deltac=(results_score2$mean-results_score1$mean)/(sqrt(results_score2$se^2+results_score1$se^2))
#2*pnorm(deltac,lower.tail = F)
     
df_cindex$Score <- factor(df_cindex$Score, levels = c("PCE 10 year", "30 Year", "MSGene"))
cp <- ggplot(df_cindex, aes(x = Score, y = Cindex,fill=Score)) +
  geom_bar(stat = "identity", position = position_dodge()) +
  geom_errorbar(aes(ymin=ymin, ymax=ymax), width=0.1, position=position_dodge(0.9)) +
  ylim(0,0.8 ) +
  labs(
    title = "Comparison of Predictive Performance",
    subtitle = "Using Bootstrap 95% CI for C-index (Concordance Index)",
    y = "C-index Value",
    x = ""
  ) +
  theme_classic()+scale_fill_manual(values = c("darkblue","darkgreen","red3"))


cp
```


Now do for continous variable: 

```{r}


# Fit functions for score1 and score2
fit_function_score1 <- function(data) coxph(Surv(start, stop, event) ~ score1, data = data)
fit_function_score2 <- function(data) coxph(Surv(start, stop, event) ~ score2, data)
#[data$stop<=(data$start+30),])
fit_function_score3 <- function(data) coxph(Surv(start, stop, event) ~ score3, data = data)

df=test
df$Cad_0_censor_age=round(df$Cad_0_censor_age,0)
df$Cad_0_Any=ifelse(df$Cad_0_Any==2,1,0)
bad_indices=which(df$Cad_0_censor_age>=80&df$Cad_0_Any==1)


expanded_df <- data.frame()

score1_list=states
names(score1_list)=df$identifier
score2=ascvd.30.year.rc
rownames(score2)=df$identifier

score3=pce.reverse.tenyear
rownames(score3)=df$identifier

# Removing the bad IDs from score1_list
score1_list <- score1_list[-bad_indices]

# Removing the bad IDs from score2 dataframe
score2 <- score2[-bad_indices, ]

# Removing the bad IDs from score2 dataframe
score3 <- score3[-bad_indices, ]

df=df[-which(df$Cad_0_censor_age>=80&df$Cad_0_Any==1),]
dim(df)


all.equal(as.numeric(names(score1_list)),as.numeric(df$identifier))

all.equal(as.numeric(rownames(score2)),as.numeric(df$identifier))

all.equal(as.numeric(rownames(score3)),as.numeric(df$identifier))
# Initialize a list to store the results
expanded_list <- vector("list", length = nrow(df))

for(i in 1:nrow(df)) {
  #print(i)
  id <- df$id[i]
  max_age <- df$Cad_0_censor_age[i]
  event <- df$Cad_0_Any[i]
   enroll = df$phenos.enrollment[i]
  
  # When max_age is less than 40 or length of score1_list[i] is 0
  if (max_age < 40 || length(score1_list[[i]]) == 0) {
    next  # Skip this iteration and proceed to the next
  }
  
  age_range <- 40:(40 + length(score1_list[[i]]) - 1)
  score1_values <- score1_list[[i]]
  score2_values <- score2[i, age_range - 39]
  score3_values <- score3[i, age_range - 39]
  
  # If there's an event and score1 is shorter than expected
  if (event == 1 && max(age_range) < max_age) {
    extended_age_range <- (max(age_range) + 1):max_age  
    score1_last_value <- rep(tail(score1_list[[i]], 1), times = length(extended_age_range))
    score1_values <- c(score1_list[[i]], score1_last_value)
    score2_last_value <- score2[i,(extended_age_range-39)]
    score2_values <- c(score2_values, score2_last_value)
    score3_last_value <- score3[i,(extended_age_range-39)]
    score3_values <- c(score3_values, score3_last_value)
    age_range <- c(age_range, extended_age_range)
  }
  
  # Store the resulting dataframe as a list element
  expanded_list[[i]] <- data.frame(id = id,
                                   age = age_range,
                                   score1 = score1_values,
                                   score2 = score2_values,
                                   score3 = score3_values,
                                   enroll=enroll,
                                   event = ifelse(age_range == max_age, event, 0))
}

# Combine all the dataframes in the list at once
expanded_df <- do.call(rbind, expanded_list)
expanded_df$score1=expanded_df$score1*100
expanded_df$start <- expanded_df$age
expanded_df$stop <- expanded_df$age + 1


print(dim(expanded_df))

expanded_df=expanded_df[expanded_df$start>=expanded_df$enroll,]


# Bootstrap C-index
results_score1 <- bootstrap_cindex(fit_function_score1, expanded_df)
results_score2 <- bootstrap_cindex(fit_function_score2, expanded_df)
results_score3 <- bootstrap_cindex(fit_function_score3, expanded_df)


# difference between States and FRS30
# deltac=(results_score1$mean-results_score2$mean)/(sqrt(results_score1$se^2+results_score2$se^2))
# 2*pnorm(deltac,lower.tail = F)
# 
# # difference between States and PCE
# deltac=(results_score1$mean-results_score3$mean)/(sqrt(results_score3$se^2+results_score1$se^2))
# 2*pnorm(deltac,lower.tail = F)
# Confidence intervals (95%)
ci_score1 <- c(results_score1$mean - 1.96*results_score1$se, results_score1$mean + 1.96*results_score1$se)
ci_score2 <- c(results_score2$mean - 1.96*results_score2$se, results_score2$mean + 1.96*results_score2$se)
ci_score3 <- c(results_score3$mean - 1.96*results_score3$se, results_score3$mean + 1.96*results_score3$se)

# Plot using ggplot2
library(ggplot2)

(df_cindex <- data.frame(
  Score = c( "MSGene","30 Year","Ten Year"),
  Cindex = c(results_score1$mean, results_score2$mean,results_score3$mean),
  ymin = c(ci_score1[1], ci_score2[1],ci_score3[1]),
  ymax = c(ci_score1[2], ci_score2[2],ci_score3[2])
))


#      Score    Cindex      ymin      ymax
# 1   MSGene 0.7087781 0.7030549 0.7145013
# 2  30 Year 0.6641906 0.6613608 0.6670204
# 3 Ten Year 0.6686567 0.6626779 0.6746356

#      Score    Cindex      ymin      ymax
# 1   MSGene 0.7381202 0.7309171 0.7453232
# 2  30 Year 0.6549914 0.6494579 0.6605249
# 3 Ten Year 0.6684417 0.6637123 0.6731711

p <- ggplot(df_cindex, aes(x = Score, y = Cindex,fill=Score)) +
  geom_bar(stat = "identity", position = position_dodge()) +
  geom_errorbar(aes(ymin=ymin, ymax=ymax), width=0.1, position=position_dodge(0.9)) +
  ylim(0,0.8 ) +
  labs(
    title = "Comparison of Predictive Performance",
    subtitle = "Using Bootstrap 95% CI for C-index (Concordance Index)",
    y = "C-index Value",
    x = ""
  ) +
  theme_classic()+scale_fill_aaas()

print(p)


```

## Analaysis with Ethnitiy

```{r}
rm(list=ls())
rm(list=ls())
gae=fread("~/Library/CloudStorage/Dropbox-Personal/ukb.kgp_projected.tsv.gz")
pop="EAS"
print(pop)
popid=gae$eid[gae$rf80%in%pop]
test=readRDS("~/multistate2/output/test.rds")
states=readRDS("~/multistate2/output/state_occupancy_risk.rds")
names(states)=test$identifier
pce.reverse.tenyear=readRDS("~/multistate2/output/pce.reverse.tenyear.rds")
ascvd.30.year=readRDS("~/multistate2/output/ascvd.30year.rds")
ascvd.30.year.rc=readRDS("~/multistate2/output/ascvd.30year.rcnew.rds")

rownames(ascvd.30.year.rc)=rownames(ascvd.30.year)=rownames(pce.reverse.tenyear)=test$identifier

test=test[test$identifier%in%popid,]
states=states[names(states)%in%popid]

pce.reverse.tenyear=pce.reverse.tenyear[rownames(pce.reverse.tenyear)%in%popid,]
ascvd.30.year=ascvd.30.year[rownames(ascvd.30.year)%in%popid,]
ascvd.30.year.rc=ascvd.30.year.rc[rownames(ascvd.30.year.rc)%in%popid,]




      
#head(pce.reverse.tenyear)
agesint=c(40:80)
thresh=5;
ten=apply(pce.reverse.tenyear,1,function(x){min(agesint[x>thresh])})
thresh=10;
thirty=apply(ascvd.30.year.rc,1,function(x){
  w=which(x>thresh)
  ifelse(length(w)>0,min(agesint[w]),100)})


### this is the data frame with approportiate score

ages=c(40:80)
thresh=0.10;
t=sapply(1:length(states),function(x){w=which(states[[x]]>thresh);ifelse(length(w)>0,min(ages[w]),100)})

df=data.frame("id"=test$identifier,"Cad_0_Any"=test$Cad_0_Any,"Cad_0_censor_age"=test$Cad_0_censor_age,"sex"=test$f.31.0.0,"prs"=test$cad.prs,"ten"=ten,"thirty"=thirty,"ms"=t,"enroll"=test$phenos.enrollment)

data <- data.frame(t_val = t)
# Create the ggplot histogram
p <- ggplot(data, aes(x = t_val)) +
geom_histogram(bins = length(ages) - 1, fill = "red3", color = "black", alpha = 0.7, aes(y =after_stat(density))) +
labs(title = "Histogram of Age Exceeding Risk: MSGene Lifetime",
x = "Age Exceeded",
y = "Density")+theme_classic()+lims(y=c(0,0.30))


data <- data.frame(t_val = ten)
# Create the ggplot histogram
p2 <- ggplot(data, aes(x = t_val)) +
geom_histogram(bins = length(ages) - 1, fill = "darkblue", color = "black", alpha = 0.7, aes(y =after_stat(density))) +
labs(title = "Histogram of Age Exceeding Risk: Ten-year (Pooled Cohort Equation)",
x = "Age Exceeded",y = "Density")+theme_classic()+xlim(39,80)+lims(y=c(0,0.30))

data <- data.frame(t_val = thirty)
# Create the ggplot histogram
p3 <- ggplot(data, aes(x = t_val)) +
geom_histogram(bins = length(ages) - 1, fill = "darkgreen", color = "black", alpha = 0.7, aes(y =after_stat(density))) +
labs(title = "Histogram of Age Exceeding Risk: 30-year (Framingham recalibrated)",
x = "Age Exceeded",y = "Density")+theme_classic()

 gathresh=ggarrange(p,p2,p3,nrow = 3)
gathresh
```

## Including Plots

You can also embed plots, for example:

```{r , echo=FALSE}
df_expanded <- data.frame(
  id = integer(), 
  start = numeric(), 
  stop = numeric(), 
  event = integer(), 
  score1 = integer(), 
  score2 = integer(),
  score3 = integer()
)

library(data.table)

# Convert df to data.table
# Convert df to data.table
setDT(df)

expand_data <- function(id, cad_status, censor_age, score1_age, score2_age,score3_age,enroll) {
  ages <- sort(c(enroll, score1_age, score2_age,score3_age, censor_age))
  result <- list()
  
  for(j in 1:(length(ages) - 1)) {
    start_age <- ages[j]
    stop_age <- ages[j+1]
    
    if(start_age == stop_age) next # skip if they are the same
    
    s1 <- ifelse(start_age >= score1_age, 1, 0)
    s2 <- ifelse(start_age >= score2_age, 1, 0)
    s3 <- ifelse(start_age >= score3_age, 1, 0)
    
    event_at_stop <- ifelse(stop_age == censor_age && cad_status == 2, 1, 0)
    
    result[[length(result) + 1]] <- list(id = id, start = start_age, stop = stop_age, event = event_at_stop, score1 = s1, score2 = s2, score3=s3,enroll=enroll)
  }
  
  return(result)
}

list_dt <- lapply(1:nrow(df), function(i) {
  row <- df[i,]
  expand_data(row$id, row$Cad_0_Any, row$Cad_0_censor_age, row$thirty, row$ms,row$ten,row$enroll)
})



# score1 is FRS30y
# score2 MSGene
# score3 TenY

df_expanded <- rbindlist(unlist(list_dt, recursive = FALSE))

## left censor for calculation
df_expanded=df_expanded[df_expanded$start>=df_expanded$enroll,]

library(survival)

# Bootstrap function for C-index
bootstrap_cindex <- function(fit_function, data, n_iter=10) {
  cindices <- numeric(n_iter)
  
  for(i in 1:n_iter) {
    sample_rows <- sample(1:nrow(data), replace = TRUE)
    sample_data <- data[sample_rows, ]
    
    fit <- fit_function(sample_data)
    cindices[i] <- summary(fit)$concordance[1]
  }
  
  return(list(mean = mean(cindices), se = sd(cindices)))
}

# Fit functions for score1 and score2
fit_function_score1 <- function(data) coxph(Surv(start, stop, event) ~ score1, data=data)
fit_function_score2 <- function(data) coxph(Surv(start, stop, event) ~ score2, data = data)
fit_function_score3 <- function(data) coxph(Surv(start, stop, event) ~ score3, data = data) #[data$stop<(data$start+10),])



# Bootstrap C-index

results_score1 <- bootstrap_cindex(fit_function_score1, df_expanded)
results_score2 <- bootstrap_cindex(fit_function_score2, df_expanded)
results_score3 <- bootstrap_cindex(fit_function_score3, df_expanded)


# Confidence intervals (95%)
ci_score1 <- c(results_score1$mean - 1.96*results_score1$se, results_score1$mean + 1.96*results_score1$se)
ci_score2 <- c(results_score2$mean - 1.96*results_score2$se, results_score2$mean + 1.96*results_score2$se)
ci_score3 <- c(results_score3$mean - 1.96*results_score3$se, results_score3$mean + 1.96*results_score2$se)

# Plot using ggplot2
library(ggplot2)

df_cindex <- data.frame(
  Score = c("PCE 10 year","30 Year","MSGene"),
  Cindex = c(results_score3$mean,results_score1$mean,results_score2$mean),
  ymin = c(ci_score3[1], ci_score1[1],ci_score2[1]),
  ymax = c(ci_score3[1], ci_score1[2],ci_score2[2])
  
)



df_cindex
#         Score    Cindex      ymin      ymax
# 1 PCE 10 year 0.5499947 0.5472029 0.5472029
# 2     30 Year 0.5178130 0.5169781 0.5186479
# 3      MSGene 0.7244679 0.7182022 0.7307336

# df_cindex using full  window
# Score    Cindex      ymin      ymax
#1 PCE 10 year 0.5793123 0.5755219 0.5755219
#2     30 Year 0.5304823 0.5282367 0.5327279
#3      MSGene 0.6994852 0.6958186 0.7031518
     
## for 2 v 3 2*(pnorm(28.33,lower.tail = F))
     
#deltac=(results_score2$mean-results_score1$mean)/(sqrt(results_score2$se^2+results_score1$se^2))
#2*pnorm(deltac,lower.tail = F)
     
df_cindex$Score <- factor(df_cindex$Score, levels = c("PCE 10 year", "30 Year", "MSGene"))
cp <- ggplot(df_cindex, aes(x = Score, y = Cindex,fill=Score)) +
  geom_bar(stat = "identity", position = position_dodge()) +
  geom_errorbar(aes(ymin=ymin, ymax=ymax), width=0.1, position=position_dodge(0.9)) +
  ylim(0,0.8 ) +
  labs(
    title = "Comparison of Predictive Performance",
    subtitle = "Using Bootstrap 95% CI for C-index (Concordance Index)",
    y = "C-index Value",
    x = ""
  ) +
  theme_classic()+scale_fill_manual(values = c("darkblue","darkgreen","red3"))


cp
```


Now do for continous variable: 

```{r}


# Fit functions for score1 and score2
fit_function_score1 <- function(data) coxph(Surv(start, stop, event) ~ score1, data = data)
fit_function_score2 <- function(data) coxph(Surv(start, stop, event) ~ score2, data)
#[data$stop<=(data$start+30),])
fit_function_score3 <- function(data) coxph(Surv(start, stop, event) ~ score3, data = data)

df=test
df$Cad_0_censor_age=round(df$Cad_0_censor_age,0)
df$Cad_0_Any=ifelse(df$Cad_0_Any==2,1,0)
#bad_indices=which(df$Cad_0_censor_age>=80&df$Cad_0_Any==1)


expanded_df <- data.frame()

score1_list=states
names(score1_list)=df$identifier
score2=ascvd.30.year.rc
rownames(score2)=df$identifier

score3=pce.reverse.tenyear
rownames(score3)=df$identifier

# Removing the bad IDs from score1_list
#score1_list <- score1_list[-bad_indices]

# Removing the bad IDs from score2 dataframe
#score2 <- score2[-bad_indices, ]

# Removing the bad IDs from score2 dataframe
#score3 <- score3[-bad_indices, ]

#df=df[-which(df$Cad_0_censor_age>=80&df$Cad_0_Any==1),]
#dim(df)


all.equal(as.numeric(names(score1_list)),as.numeric(df$identifier))

all.equal(as.numeric(rownames(score2)),as.numeric(df$identifier))

all.equal(as.numeric(rownames(score3)),as.numeric(df$identifier))
# Initialize a list to store the results
expanded_list <- vector("list", length = nrow(df))

for(i in 1:nrow(df)) {
  #print(i)
  id <- df$id[i]
  max_age <- df$Cad_0_censor_age[i]
  event <- df$Cad_0_Any[i]
   enroll = df$phenos.enrollment[i]
  
  # When max_age is less than 40 or length of score1_list[i] is 0
  if (max_age < 40 || length(score1_list[[i]]) == 0) {
    next  # Skip this iteration and proceed to the next
  }
  
  age_range <- 40:(40 + length(score1_list[[i]]) - 1)
  score1_values <- score1_list[[i]]
  score2_values <- score2[i, age_range - 39]
  score3_values <- score3[i, age_range - 39]
  
  # If there's an event and score1 is shorter than expected
  if (event == 1 && max(age_range) < max_age) {
    extended_age_range <- (max(age_range) + 1):max_age  
    score1_last_value <- rep(tail(score1_list[[i]], 1), times = length(extended_age_range))
    score1_values <- c(score1_list[[i]], score1_last_value)
    score2_last_value <- score2[i,(extended_age_range-39)]
    score2_values <- c(score2_values, score2_last_value)
    score3_last_value <- score3[i,(extended_age_range-39)]
    score3_values <- c(score3_values, score3_last_value)
    age_range <- c(age_range, extended_age_range)
  }
  
  # Store the resulting dataframe as a list element
  expanded_list[[i]] <- data.frame(id = id,
                                   age = age_range,
                                   score1 = score1_values,
                                   score2 = score2_values,
                                   score3 = score3_values,
                                   enroll=enroll,
                                   event = ifelse(age_range == max_age, event, 0))
}

# Combine all the dataframes in the list at once
expanded_df <- do.call(rbind, expanded_list)
expanded_df$score1=expanded_df$score1*100
expanded_df$start <- expanded_df$age
expanded_df$stop <- expanded_df$age + 1


print(dim(expanded_df))

expanded_df=expanded_df[expanded_df$start>=expanded_df$enroll,]


# Bootstrap C-index
results_score1 <- bootstrap_cindex(fit_function_score1, expanded_df)
results_score2 <- bootstrap_cindex(fit_function_score2, expanded_df)
results_score3 <- bootstrap_cindex(fit_function_score3, expanded_df)


# difference between States and FRS30
# deltac=(results_score1$mean-results_score2$mean)/(sqrt(results_score1$se^2+results_score2$se^2))
# 2*pnorm(deltac,lower.tail = F)
# 
# # difference between States and PCE
# deltac=(results_score1$mean-results_score3$mean)/(sqrt(results_score3$se^2+results_score1$se^2))
# 2*pnorm(deltac,lower.tail = F)
# Confidence intervals (95%)
ci_score1 <- c(results_score1$mean - 1.96*results_score1$se, results_score1$mean + 1.96*results_score1$se)
ci_score2 <- c(results_score2$mean - 1.96*results_score2$se, results_score2$mean + 1.96*results_score2$se)
ci_score3 <- c(results_score3$mean - 1.96*results_score3$se, results_score3$mean + 1.96*results_score3$se)

# Plot using ggplot2
library(ggplot2)

(df_cindex <- data.frame(
  Score = c( "MSGene","30 Year","Ten Year"),
  Cindex = c(results_score1$mean, results_score2$mean,results_score3$mean),
  ymin = c(ci_score1[1], ci_score2[1],ci_score3[1]),
  ymax = c(ci_score1[2], ci_score2[2],ci_score3[2])
))


#      Score    Cindex      ymin      ymax
# 1   MSGene 0.7087781 0.7030549 0.7145013
# 2  30 Year 0.6641906 0.6613608 0.6670204
# 3 Ten Year 0.6686567 0.6626779 0.6746356

#      Score    Cindex      ymin      ymax
# 1   MSGene 0.7381202 0.7309171 0.7453232
# 2  30 Year 0.6549914 0.6494579 0.6605249
# 3 Ten Year 0.6684417 0.6637123 0.6731711

p <- ggplot(df_cindex, aes(x = Score, y = Cindex,fill=Score)) +
  geom_bar(stat = "identity", position = position_dodge()) +
  geom_errorbar(aes(ymin=ymin, ymax=ymax), width=0.1, position=position_dodge(0.9)) +
  ylim(0,0.8 ) +
  labs(
    title = "Comparison of Predictive Performance",
    subtitle = "Using Bootstrap 95% CI for C-index (Concordance Index)",
    y = "C-index Value",
    x = ""
  ) +
  theme_classic()+scale_fill_aaas()

print(p)


```



## Analaysis with Ethnitiy

```{r}
rm(list=ls())

gae=fread("~/Library/CloudStorage/Dropbox-Personal/ukb.kgp_projected.tsv.gz")
pop="SAS"
print(pop)
popid=gae$eid[gae$rf80%in%pop]
test=readRDS("~/multistate2/output/test.rds")
states=readRDS("~/multistate2/output/state_occupancy_risk.rds")
names(states)=test$identifier
pce.reverse.tenyear=readRDS("~/multistate2/output/pce.reverse.tenyear.rds")
ascvd.30.year=readRDS("~/multistate2/output/ascvd.30year.rds")
ascvd.30.year.rc=readRDS("~/multistate2/output/ascvd.30year.rcnew.rds")

rownames(ascvd.30.year.rc)=rownames(ascvd.30.year)=rownames(pce.reverse.tenyear)=test$identifier

test=test[test$identifier%in%popid,]
states=states[names(states)%in%popid]

pce.reverse.tenyear=pce.reverse.tenyear[rownames(pce.reverse.tenyear)%in%popid,]
ascvd.30.year=ascvd.30.year[rownames(ascvd.30.year)%in%popid,]
ascvd.30.year.rc=ascvd.30.year.rc[rownames(ascvd.30.year.rc)%in%popid,]


      
#head(pce.reverse.tenyear)
agesint=c(40:80)
thresh=5;
ten=apply(pce.reverse.tenyear,1,function(x){min(agesint[x>thresh])})
thresh=10;
thirty=apply(ascvd.30.year.rc,1,function(x){
  w=which(x>thresh)
  ifelse(length(w)>0,min(agesint[w]),100)})


### this is the data frame with approportiate score

ages=c(40:80)
thresh=0.10;
t=sapply(1:length(states),function(x){w=which(states[[x]]>thresh);ifelse(length(w)>0,min(ages[w]),100)})

df=data.frame("id"=test$identifier,"Cad_0_Any"=test$Cad_0_Any,"Cad_0_censor_age"=test$Cad_0_censor_age,"sex"=test$f.31.0.0,"prs"=test$cad.prs,"ten"=ten,"thirty"=thirty,"ms"=t,"enroll"=test$phenos.enrollment)

data <- data.frame(t_val = t)
# Create the ggplot histogram
p <- ggplot(data, aes(x = t_val)) +
geom_histogram(bins = length(ages) - 1, fill = "red3", color = "black", alpha = 0.7, aes(y =after_stat(density))) +
labs(title = "Histogram of Age Exceeding Risk: MSGene Lifetime",
x = "Age Exceeded",
y = "Density")+theme_classic()+lims(y=c(0,0.30))


data <- data.frame(t_val = ten)
# Create the ggplot histogram
p2 <- ggplot(data, aes(x = t_val)) +
geom_histogram(bins = length(ages) - 1, fill = "darkblue", color = "black", alpha = 0.7, aes(y =after_stat(density))) +
labs(title = "Histogram of Age Exceeding Risk: Ten-year (Pooled Cohort Equation)",
x = "Age Exceeded",y = "Density")+theme_classic()+xlim(39,80)+lims(y=c(0,0.30))

data <- data.frame(t_val = thirty)
# Create the ggplot histogram
p3 <- ggplot(data, aes(x = t_val)) +
geom_histogram(bins = length(ages) - 1, fill = "darkgreen", color = "black", alpha = 0.7, aes(y =after_stat(density))) +
labs(title = "Histogram of Age Exceeding Risk: 30-year (Framingham recalibrated)",
x = "Age Exceeded",y = "Density")+theme_classic()

 gathresh=ggarrange(p,p2,p3,nrow = 3)
gathresh
```

## Including Plots

You can also embed plots, for example:

```{r , echo=FALSE}
df_expanded <- data.frame(
  id = integer(), 
  start = numeric(), 
  stop = numeric(), 
  event = integer(), 
  score1 = integer(), 
  score2 = integer(),
  score3 = integer()
)

library(data.table)

# Convert df to data.table
# Convert df to data.table
setDT(df)

expand_data <- function(id, cad_status, censor_age, score1_age, score2_age,score3_age,enroll) {
  ages <- sort(c(enroll, score1_age, score2_age,score3_age, censor_age))
  result <- list()
  
  for(j in 1:(length(ages) - 1)) {
    start_age <- ages[j]
    stop_age <- ages[j+1]
    
    if(start_age == stop_age) next # skip if they are the same
    
    s1 <- ifelse(start_age >= score1_age, 1, 0)
    s2 <- ifelse(start_age >= score2_age, 1, 0)
    s3 <- ifelse(start_age >= score3_age, 1, 0)
    
    event_at_stop <- ifelse(stop_age == censor_age && cad_status == 2, 1, 0)
    
    result[[length(result) + 1]] <- list(id = id, start = start_age, stop = stop_age, event = event_at_stop, score1 = s1, score2 = s2, score3=s3,enroll=enroll)
  }
  
  return(result)
}

list_dt <- lapply(1:nrow(df), function(i) {
  row <- df[i,]
  expand_data(row$id, row$Cad_0_Any, row$Cad_0_censor_age, row$thirty, row$ms,row$ten,row$enroll)
})



# score1 is FRS30y
# score2 MSGene
# score3 TenY

df_expanded <- rbindlist(unlist(list_dt, recursive = FALSE))

## left censor for calculation
df_expanded=df_expanded[df_expanded$start>=df_expanded$enroll,]

library(survival)

# Bootstrap function for C-index
bootstrap_cindex <- function(fit_function, data, n_iter=10) {
  cindices <- numeric(n_iter)
  
  for(i in 1:n_iter) {
    sample_rows <- sample(1:nrow(data), replace = TRUE)
    sample_data <- data[sample_rows, ]
    
    fit <- fit_function(sample_data)
    cindices[i] <- summary(fit)$concordance[1]
  }
  
  return(list(mean = mean(cindices), se = sd(cindices)))
}

# Fit functions for score1 and score2
fit_function_score1 <- function(data) coxph(Surv(start, stop, event) ~ score1, data=data)
fit_function_score2 <- function(data) coxph(Surv(start, stop, event) ~ score2, data = data)
fit_function_score3 <- function(data) coxph(Surv(start, stop, event) ~ score3, data = data) #[data$stop<(data$start+10),])



# Bootstrap C-index

results_score1 <- bootstrap_cindex(fit_function_score1, df_expanded)
results_score2 <- bootstrap_cindex(fit_function_score2, df_expanded)
results_score3 <- bootstrap_cindex(fit_function_score3, df_expanded)


# Confidence intervals (95%)
ci_score1 <- c(results_score1$mean - 1.96*results_score1$se, results_score1$mean + 1.96*results_score1$se)
ci_score2 <- c(results_score2$mean - 1.96*results_score2$se, results_score2$mean + 1.96*results_score2$se)
ci_score3 <- c(results_score3$mean - 1.96*results_score3$se, results_score3$mean + 1.96*results_score2$se)

# Plot using ggplot2
library(ggplot2)

df_cindex <- data.frame(
  Score = c("PCE 10 year","30 Year","MSGene"),
  Cindex = c(results_score3$mean,results_score1$mean,results_score2$mean),
  ymin = c(ci_score3[1], ci_score1[1],ci_score2[1]),
  ymax = c(ci_score3[1], ci_score1[2],ci_score2[2])
  
)



df_cindex
#         Score    Cindex      ymin      ymax
# 1 PCE 10 year 0.5499947 0.5472029 0.5472029
# 2     30 Year 0.5178130 0.5169781 0.5186479
# 3      MSGene 0.7244679 0.7182022 0.7307336

# df_cindex using full  window
# Score    Cindex      ymin      ymax
#1 PCE 10 year 0.5793123 0.5755219 0.5755219
#2     30 Year 0.5304823 0.5282367 0.5327279
#3      MSGene 0.6994852 0.6958186 0.7031518
     
## for 2 v 3 2*(pnorm(28.33,lower.tail = F))
     
#deltac=(results_score2$mean-results_score1$mean)/(sqrt(results_score2$se^2+results_score1$se^2))
#2*pnorm(deltac,lower.tail = F)
     
df_cindex$Score <- factor(df_cindex$Score, levels = c("PCE 10 year", "30 Year", "MSGene"))
cp <- ggplot(df_cindex, aes(x = Score, y = Cindex,fill=Score)) +
  geom_bar(stat = "identity", position = position_dodge()) +
  geom_errorbar(aes(ymin=ymin, ymax=ymax), width=0.1, position=position_dodge(0.9)) +
  ylim(0,0.9 ) +
  labs(
    title = "Comparison of Predictive Performance",
    subtitle = "Using Bootstrap 95% CI for C-index (Concordance Index)",
    y = "C-index Value",
    x = ""
  ) +
  theme_classic()+scale_fill_manual(values = c("darkblue","darkgreen","red3"))


cp
```


Now do for continous variable: 

```{r}


# Fit functions for score1 and score2
fit_function_score1 <- function(data) coxph(Surv(start, stop, event) ~ score1, data = data)
fit_function_score2 <- function(data) coxph(Surv(start, stop, event) ~ score2, data)
#[data$stop<=(data$start+30),])
fit_function_score3 <- function(data) coxph(Surv(start, stop, event) ~ score3, data = data)

df=test
df$Cad_0_censor_age=round(df$Cad_0_censor_age,0)
df$Cad_0_Any=ifelse(df$Cad_0_Any==2,1,0)
bad_indices=which(df$Cad_0_censor_age>=80&df$Cad_0_Any==1)


expanded_df <- data.frame()

score1_list=states
names(score1_list)=df$identifier
score2=ascvd.30.year.rc
rownames(score2)=df$identifier

score3=pce.reverse.tenyear
rownames(score3)=df$identifier

# Removing the bad IDs from score1_list
score1_list <- score1_list[-bad_indices]

# Removing the bad IDs from score2 dataframe
score2 <- score2[-bad_indices, ]

# Removing the bad IDs from score2 dataframe
score3 <- score3[-bad_indices, ]

df=df[-which(df$Cad_0_censor_age>=80&df$Cad_0_Any==1),]
dim(df)


all.equal(as.numeric(names(score1_list)),as.numeric(df$identifier))

all.equal(as.numeric(rownames(score2)),as.numeric(df$identifier))

all.equal(as.numeric(rownames(score3)),as.numeric(df$identifier))
# Initialize a list to store the results
expanded_list <- vector("list", length = nrow(df))

for(i in 1:nrow(df)) {
  #print(i)
  id <- df$id[i]
  max_age <- df$Cad_0_censor_age[i]
  event <- df$Cad_0_Any[i]
   enroll = df$phenos.enrollment[i]
  
  # When max_age is less than 40 or length of score1_list[i] is 0
  if (max_age < 40 || length(score1_list[[i]]) == 0) {
    next  # Skip this iteration and proceed to the next
  }
  
  age_range <- 40:(40 + length(score1_list[[i]]) - 1)
  score1_values <- score1_list[[i]]
  score2_values <- score2[i, age_range - 39]
  score3_values <- score3[i, age_range - 39]
  
  # If there's an event and score1 is shorter than expected
  if (event == 1 && max(age_range) < max_age) {
    extended_age_range <- (max(age_range) + 1):max_age  
    score1_last_value <- rep(tail(score1_list[[i]], 1), times = length(extended_age_range))
    score1_values <- c(score1_list[[i]], score1_last_value)
    score2_last_value <- score2[i,(extended_age_range-39)]
    score2_values <- c(score2_values, score2_last_value)
    score3_last_value <- score3[i,(extended_age_range-39)]
    score3_values <- c(score3_values, score3_last_value)
    age_range <- c(age_range, extended_age_range)
  }
  
  # Store the resulting dataframe as a list element
  expanded_list[[i]] <- data.frame(id = id,
                                   age = age_range,
                                   score1 = score1_values,
                                   score2 = score2_values,
                                   score3 = score3_values,
                                   enroll=enroll,
                                   event = ifelse(age_range == max_age, event, 0))
}

# Combine all the dataframes in the list at once
expanded_df <- do.call(rbind, expanded_list)
expanded_df$score1=expanded_df$score1*100
expanded_df$start <- expanded_df$age
expanded_df$stop <- expanded_df$age + 1


print(dim(expanded_df))

expanded_df=expanded_df[expanded_df$start>=expanded_df$enroll,]


# Bootstrap C-index
results_score1 <- bootstrap_cindex(fit_function_score1, expanded_df)
results_score2 <- bootstrap_cindex(fit_function_score2, expanded_df)
results_score3 <- bootstrap_cindex(fit_function_score3, expanded_df)


# difference between States and FRS30
# deltac=(results_score1$mean-results_score2$mean)/(sqrt(results_score1$se^2+results_score2$se^2))
# 2*pnorm(deltac,lower.tail = F)
# 
# # difference between States and PCE
# deltac=(results_score1$mean-results_score3$mean)/(sqrt(results_score3$se^2+results_score1$se^2))
# 2*pnorm(deltac,lower.tail = F)
# Confidence intervals (95%)
ci_score1 <- c(results_score1$mean - 1.96*results_score1$se, results_score1$mean + 1.96*results_score1$se)
ci_score2 <- c(results_score2$mean - 1.96*results_score2$se, results_score2$mean + 1.96*results_score2$se)
ci_score3 <- c(results_score3$mean - 1.96*results_score3$se, results_score3$mean + 1.96*results_score3$se)

# Plot using ggplot2
library(ggplot2)

(df_cindex <- data.frame(
  Score = c( "MSGene","30 Year","Ten Year"),
  Cindex = c(results_score1$mean, results_score2$mean,results_score3$mean),
  ymin = c(ci_score1[1], ci_score2[1],ci_score3[1]),
  ymax = c(ci_score1[2], ci_score2[2],ci_score3[2])
))


#      Score    Cindex      ymin      ymax
# 1   MSGene 0.7087781 0.7030549 0.7145013
# 2  30 Year 0.6641906 0.6613608 0.6670204
# 3 Ten Year 0.6686567 0.6626779 0.6746356

#      Score    Cindex      ymin      ymax
# 1   MSGene 0.7381202 0.7309171 0.7453232
# 2  30 Year 0.6549914 0.6494579 0.6605249
# 3 Ten Year 0.6684417 0.6637123 0.6731711

p <- ggplot(df_cindex, aes(x = Score, y = Cindex,fill=Score)) +
  geom_bar(stat = "identity", position = position_dodge()) +
  geom_errorbar(aes(ymin=ymin, ymax=ymax), width=0.1, position=position_dodge(0.9)) +
  ylim(0,0.8 ) +
  labs(
    title = "Comparison of Predictive Performance",
    subtitle = "Using Bootstrap 95% CI for C-index (Concordance Index)",
    y = "C-index Value",
    x = ""
  ) +
  theme_classic()+scale_fill_aaas()

print(p)


```











