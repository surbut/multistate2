mpce=readRDS("~/multistate/output/mpcecomplete.rds")
ls()
head(mpce)
mpce$antihtn
nstates=c("Health", "Ht","HyperLip","Dm","Cad","death","Ht&HyperLip","HyperLip&Dm","Ht&Dm","Ht&HyperLip&Dm")
sum(mpce$Cad_0_Any==2)
old=fread("~/Dropbox/phenotypes/Coronary_Artery_Disease_HARD.tab.tsv")
library(data.table)
old=fread("~/Dropbox/phenotypes/Coronary_Artery_Disease_HARD.tab.tsv")
head(old)
sum(old$has_disease==1)
ages=c(40:80)
dfp=mpce
abinom = fitfunc(df_frame = dfp,
ages = ages,
nstates = nstates,mode = "binomial",covariates = "cad.prs+yearsinstate+statin_now+antihtn_now+f.31.0.0")
source("~/multistate/code/fitarray.R")
abinom = fitfunc(df_frame = dfp,
ages = ages,
nstates = nstates,mode = "binomial",covariates = "cad.prs+yearsinstate+statin_now+antihtn_now+f.31.0.0")
library(dplyr)
abinom = fitfunc(df_frame = dfp,
ages = ages,
nstates = nstates,mode = "binomial",covariates = "cad.prs+yearsinstate+statin_now+antihtn_now+f.31.0.0")
abinom$model_list$40
abinom$model_list[["40"]]
source("~/multistate2/newsmooth.R")
coefsmooth
c=coefsmooth(abinom)
c=coefsmooth(ages=c(40:80),start = "Health",modelfit = abinom,stop = "Cad")
coefplotsmooth
coefplotsmooth=function(ages,start,stop,modelfit){
agenames=as.character(c(ages))
s=sapply(agenames,function(x){modelfit$model_list[[x]][[stop]][[start]][,"Estimate"]})
s=data.frame(s)
colnames(s)=agenames
s=t(s)
melt=melt(s)
g=ggplot(melt,aes(Var1,value,col=Var2))+stat_smooth()
m=ggplot_build(g)$data[[1]]
return(list("mat"=m,"plot"=g))}
coefplotsmooth=function(ages,start,stop,modelfit){
agenames=as.character(c(ages))
s=sapply(agenames,function(x){modelfit$model_list[[x]][[stop]][[start]][,"Estimate"]})
s=data.frame(s)
colnames(s)=agenames
s=t(s)
melt=melt(s)
g=ggplot(melt,aes(Var1,value,col=Var2))+stat_smooth()+geom_point()
m=ggplot_build(g)$data[[1]]
return(list("mat"=m,"plot"=g))}
coefplotsmooth(ages = ages,start = "Health",stop = "Cad",modelfit = abinom)
library(ggplot)
library(ggplot2)
coefplotsmooth(ages = ages,start = "Health",stop = "Cad",modelfit = abinom)
coefplotsmooth=function(ages,start,stop,modelfit){
require(ggplot2)
agenames=as.character(c(ages))
s=sapply(agenames,function(x){modelfit$model_list[[x]][[stop]][[start]][,"Estimate"]})
s=data.frame(s)
colnames(s)=agenames
s=t(s)
melt=melt(s)
g=ggplot(melt,aes(Var1,value,col=Var2))+stat_smooth()+geom_point()
m=ggplot_build(g)$data[[1]]
return(list("mat"=m,"plot"=g))}
coefplotsmooth(ages = ages,start = "Ht",stop = "Cad",modelfit = abinom)
plotly(coefplotsmooth(ages = ages,start = "Ht",stop = "Cad",modelfit = abinom))
library(plotly)
ggplotly(coefplotsmooth(ages = ages,start = "Ht",stop = "Cad",modelfit = abinom))
ggplotly(coefplotsmooth(ages = ages,start = "Ht",stop = "Cad",modelfit = abinom)$plot)
### return smoothed per age and coefficient
coefsmooth=
function(start,stop,ages,modelfit){
m=coefplotsmooth(ages = ages,start = start,stop = stop,modelfit = modelfit)$m
##grab mean for each age from smoothed
returnlist=lapply(seq(1:4),function(t){
df=data.frame(m[m$group==t,]%>%group_by(round(x,0))%>%summarise(mean(y)))
rownames(df)=as.character(c(ages))
colnames(df)=c("age","avgcoef")
return(df)
})
agenames=as.character(c(ages))
s=sapply(agenames,function(x){modelfit$model_list[[x]][[stop]][[start]][,"Estimate"]})
s=data.frame(s)
names(returnlist)=rownames(s)
return(returnlist)
}
### return smoothed per age and coefficient
coefsmooth=
function(start,stop,ages,modelfit){
m=coefplotsmooth(ages = ages,start = start,stop = stop,modelfit = modelfit)$m
##grab mean for each age from smoothed
returnlist=lapply(seq(1:4),function(t){
df=data.frame(m[m$group==t,]%>%group_by(round(x,0))%>%summarise(mean(y)))
rownames(df)=as.character(c(ages))
colnames(df)=c("age","avgcoef")
return(df)
})
agenames=as.character(c(ages))
s=sapply(agenames,function(x){modelfit$model_list[[x]][[stop]][[start]][,"Estimate"]})
s=data.frame(s)
names(returnlist)=rownames(s)
return(returnlist)
}
sl=coefsmooth(start = "Ht",stop = "Cad",ages = 40:80,modelfit = abinom)
coefsmooth=
function(start,stop,ages,modelfit){
m=coefplotsmooth(ages = ages,start = start,stop = stop,modelfit = modelfit,nterms=nterms)$m
##grab mean for each age from smoothed
returnlist=lapply(seq(1:nterms),function(t){
df=data.frame(m[m$group==t,]%>%group_by(round(x,0))%>%summarise(mean(y)))
rownames(df)=as.character(c(ages))
colnames(df)=c("age","avgcoef")
return(df)
})
agenames=as.character(c(ages))
s=sapply(agenames,function(x){modelfit$model_list[[x]][[stop]][[start]][,"Estimate"]})
s=data.frame(s)
names(returnlist)=rownames(s)
return(returnlist)
}
coefsmooth(start = "Ht",stop = "Cad",ages = ages,modelfit = abinom,)
### return smoothed per age and coefficient
coefsmooth=
function(start,stop,ages,modelfit){
m=coefplotsmooth(ages = ages,start = start,stop = stop,modelfit = modelfit,nterms=nterms)$m
##grab mean for each age from smoothed
returnlist=lapply(seq(1:nterms),function(t){
df=data.frame(m[m$group==t,]%>%group_by(round(x,0))%>%summarise(mean(y)))
rownames(df)=as.character(c(ages))
colnames(df)=c("age","avgcoef")
return(df)
})
agenames=as.character(c(ages))
s=sapply(agenames,function(x){modelfit$model_list[[x]][[stop]][[start]][,"Estimate"]})
s=data.frame(s)
names(returnlist)=rownames(s)
return(returnlist)
}
coefsmooth(start = "Ht",stop = "Cad",ages = ages,modelfit = abinom,nterms=6)
coefsmooth()
coefsmooth
coefsmooth=
function(start,stop,ages,modelfit,nterms=nterms){
m=coefplotsmooth(ages = ages,start = start,stop = stop,modelfit = modelfit)$m
##grab mean for each age from smoothed
returnlist=lapply(seq(1:nterms),function(t){
df=data.frame(m[m$group==t,]%>%group_by(round(x,0))%>%summarise(mean(y)))
rownames(df)=as.character(c(ages))
colnames(df)=c("age","avgcoef")
return(df)
})
agenames=as.character(c(ages))
s=sapply(agenames,function(x){modelfit$model_list[[x]][[stop]][[start]][,"Estimate"]})
s=data.frame(s)
names(returnlist)=rownames(s)
return(returnlist)
}
head(m)
m=coefplotsmooth(ages = ages,start = start,stop = stop,modelfit = modelfit)$m
modelfit=abinom
m=coefplotsmooth(ages = ages,start = start,stop = stop,modelfit = modelfit)$m
m=coefplotsmooth(ages = ages,start = start,stop = stop,modelfit = modelfit)$m
start
stop="Cad"
start="Ht"
m=coefplotsmooth(ages = ages,start = start,stop = stop,modelfit = modelfit)$m
m
levels(m$group)
m$group
as.factor(m$group)
nterms=levels(as.factor(m$group))
coefsmooth=
function(start,stop,ages,modelfit){
m=coefplotsmooth(ages = ages,start = start,stop = stop,modelfit = modelfit)$m
##grab mean for each age from smoothed
nterms=levels(as.factor(m$group))
returnlist=lapply(seq(1:nterms),function(t){
df=data.frame(m[m$group==t,]%>%group_by(round(x,0))%>%summarise(mean(y)))
rownames(df)=as.character(c(ages))
colnames(df)=c("age","avgcoef")
return(df)
})
agenames=as.character(c(ages))
s=sapply(agenames,function(x){modelfit$model_list[[x]][[stop]][[start]][,"Estimate"]})
s=data.frame(s)
names(returnlist)=rownames(s)
return(returnlist)
}
coefsmooth(start = "Ht",stop = "Cad",ages = ages,modelfit = abinom,nterms=6)
coefsmooth(start = "Ht",stop = "Cad",ages = ages,modelfit = abinom)
m=coefplotsmooth(ages = ages,start = start,stop = stop,modelfit = modelfit)$m
##grab mean for each age from smoothed
nterms=levels(as.factor(m$group))
nterms
returnlist=lapply(seq(1:nterms),function(t){
df=data.frame(m[m$group==t,]%>%group_by(round(x,0))%>%summarise(mean(y)))
rownames(df)=as.character(c(ages))
colnames(df)=c("age","avgcoef")
return(df)
})
seq(1:nterms)
returnlist=lapply(c(1:nterms),function(t){
df=data.frame(m[m$group==t,]%>%group_by(round(x,0))%>%summarise(mean(y)))
rownames(df)=as.character(c(ages))
colnames(df)=c("age","avgcoef")
return(df)
})
1:nterms
nterms
returnlist=lapply(nterms,function(t){
df=data.frame(m[m$group==t,]%>%group_by(round(x,0))%>%summarise(mean(y)))
rownames(df)=as.character(c(ages))
colnames(df)=c("age","avgcoef")
return(df)
})
agenames=as.character(c(ages))
s=sapply(agenames,function(x){modelfit$model_list[[x]][[stop]][[start]][,"Estimate"]})
s=data.frame(s)
names(returnlist)=rownames(s)
return(returnlist)
agenames=as.character(c(ages))
s=sapply(agenames,function(x){modelfit$model_list[[x]][[stop]][[start]][,"Estimate"]})
s=data.frame(s)
names(returnlist)=rownames(s)
s
convertlistmat=function(smoothedlist){
list_of_dfs <- lapply(smoothedlist, as.data.frame)
final_df <- reduce(list_of_dfs, function(x, y) merge(x, y, by="age"))
final_matrix <- as.matrix(final_df)
names(final_df)[-1]=names(smoothedlist)
return(final_df)}
convertlistmat(smoothedlist = s)
library(tidyverse)
convertlistmat(smoothedlist = s)
s
sl=coefsmooth(start = "Ht",stop = "Cad",ages = 40:80,modelfit = abinom)
### return smoothed per age and coefficient
coefsmooth=
function(start,stop,ages,modelfit){
m=coefplotsmooth(ages = ages,start = start,stop = stop,modelfit = modelfit)$m
##grab mean for each age from smoothed
nterms=as.numeric(levels(as.factor(m$group)))
returnlist=lapply(nterms,function(t){
df=data.frame(m[m$group==t,]%>%group_by(round(x,0))%>%summarise(mean(y)))
rownames(df)=as.character(c(ages))
colnames(df)=c("age","avgcoef")
return(df)
})
agenames=as.character(c(ages))
s=sapply(agenames,function(x){modelfit$model_list[[x]][[stop]][[start]][,"Estimate"]})
s=data.frame(s)
names(returnlist)=rownames(s)
return(returnlist)
}
sl=coefsmooth(start = "Ht",stop = "Cad",ages = 40:80,modelfit = abinom)
convertlistmat(s)
c=convertlistmat(sl)
c
plot(exp(c$yearsinstate))
plot(ages(c(40:80),exp(c$yearsinstate),xlab="Age",ylab="Exp(\beta)")
)
plot(c(40:80),exp(c$yearsinstate),xlab="Age",ylab="Exp(\beta)")
plot(c(40:80),exp(c$yearsinstate),xlab="Age",ylab="Exp(\beta)",ylim=c(0.5,1.5))
plot(c(40:80),exp(c$yearsinstate),xlab="Age",ylab="Exp(\beta_yearsinstate)",ylim=c(0.5,1.5))
ggplotly(coefplotsmooth(ages = ages,start = "Ht",stop = "Cad",modelfit = abinom)$plot)
